<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Job Work Dashboard Manager</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root{
    --bg:#f8f9fa; --panel:#ffffff; --card:#ffffff; --fg:#1d1d1f; --muted:#86868b;
    --acc:#007aff; --ok:#30d158; --warn:#ff9500; --bad:#ff3b30; --border:#f2f2f7;
    --impact:#5e5ce6; --important:#30b0c7; --urgent:#ff6482;
    --shadow-light:0 1px 3px rgba(0,0,0,0.04);
    --shadow-medium:0 4px 12px rgba(0,0,0,0.08);
    --shadow-heavy:0 8px 24px rgba(0,0,0,0.12);
    --shadow-float:0 12px 40px rgba(0,0,0,0.15);
    --radius:12px; --radius-xl:20px; --gap:16px; --pad:20px; --tap:44px; --maxw:1200px;
    --transition:cubic-bezier(0.25, 0.46, 0.45, 0.94);
    --font-weight-regular:400; --font-weight-medium:500; --font-weight-semibold:600; --font-weight-bold:700;
    color-scheme:light dark;
  }
  @media (prefers-color-scheme: dark){
    :root{ 
      --bg:#000000; --panel:#1c1c1e; --card:#2c2c2e; --fg:#ffffff; --muted:#98989d; 
      --border:#38383a; --shadow-light:0 1px 3px rgba(0,0,0,0.3);
      --shadow-medium:0 4px 12px rgba(0,0,0,0.4); --shadow-heavy:0 8px 24px rgba(0,0,0,0.5);
      --shadow-float:0 12px 40px rgba(0,0,0,0.6);
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font:15px/1.5 -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    letter-spacing:-0.005em;
  }
  a{color:var(--acc);text-decoration:none;transition:opacity 0.2s var(--transition)}
  a:hover{opacity:0.7}
  button{cursor:pointer;transition:all 0.2s var(--transition)}
  .link{cursor:text;}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(12px,3vw,24px)}
  header{
    position:sticky;top:0;z-index:10;
    backdrop-filter:saturate(1.8) blur(20px);
    background:color-mix(in oklab,var(--bg) 85%,transparent);
    border-bottom:1px solid var(--border);
    transition:all 0.3s var(--transition);
  }
  .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:12px 0}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:40px;height:40px;display:grid;place-items:center;border-radius:12px;
    background:linear-gradient(135deg,var(--acc) 0%, #5856d6 100%);
    box-shadow:var(--shadow-medium);font-weight:var(--font-weight-bold);
    color:white;font-size:16px;
    transition:transform 0.2s var(--transition);
  }
  .logo:hover{transform:scale(1.05)}
  .tabs{
    display:flex;gap:4px;flex-wrap:wrap;
    background:var(--panel);border:1px solid var(--border);
    padding:4px;border-radius:16px;box-shadow:var(--shadow-light);
  }
  .tab{
    padding:10px 16px;border-radius:12px;border:none;background:transparent;
    font-weight:var(--font-weight-medium);color:var(--muted);
    transition:all 0.3s var(--transition);
    position:relative;
  }
  .tab:hover:not(.active){background:color-mix(in oklab,var(--acc) 6%,transparent);color:var(--fg)}
  .tab.active{
    background:var(--acc);color:white;
    box-shadow:var(--shadow-medium);
    transform:translateY(-1px);
  }
  .rightbar{display:flex;align-items:center;gap:8px}
  .iconbtn{
    min-width:var(--tap);height:var(--tap);border-radius:14px;
    border:1px solid rgba(0,0,0,0.1);background:#d9feaf;
    display:grid;place-items:center;box-shadow:var(--shadow-light);
    font-size:18px;color:#000;
    transition:all 0.2s var(--transition);
  }
  .iconbtn:hover{
    background:#c8f49f;
    border-color:rgba(0,0,0,0.15);
    transform:translateY(-1px);
    box-shadow:var(--shadow-medium);
  }
  .iconbtn:active{transform:translateY(0) scale(0.98)}
  .hidden{display:none!important}
  
  /* Fullscreen canvas styles */
  body.canvas-fullscreen {
    overflow: hidden;
  }
  body.canvas-fullscreen header,
  body.canvas-fullscreen .universal-filters,
  body.canvas-fullscreen .fab {
    display: none !important;
  }
  body.canvas-fullscreen #view-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    padding: 0;
    margin: 0;
  }
  body.canvas-fullscreen #canvasContainer {
    width: 100vw !important;
    height: 100vh !important;
  }

  /* Canvas Toolbar Styling */
  .canvas-toolbar-floating {
    background: #e85b5b !important;
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  .canvas-toolbar-floating .iconbtn {
    background: #d9feaf !important;
    border: 1px solid rgba(0,0,0,0.1);
    color: #000000 !important;
    min-width: 40px;
    height: 40px;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
  }
  
  .canvas-toolbar-floating .iconbtn:hover {
    background: #c8f49f !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .canvas-toolbar-floating .iconbtn:active {
    transform: translateY(0) scale(0.98);
  }
  
  .canvas-toolbar-floating .iconbtn.delete-btn {
    background: #ff6b6b !important;
    color: white !important;
  }
  
  .canvas-toolbar-floating .iconbtn.delete-btn:hover {
    background: #ff5252 !important;
  }
  
  .canvas-toolbar-floating select {
    background: #d9feaf;
    border: 1px solid rgba(0,0,0,0.1);
    color: #000000;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
  }

  .panel{
    margin-top:20px;background:var(--panel);border:1px solid var(--border);
    border-radius:var(--radius-xl);box-shadow:var(--shadow-medium);
    padding:var(--pad);
    transition:all 0.3s var(--transition);
  }

  .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px}
  @media (max-width:800px){.filters{grid-template-columns:1fr 1fr}}
  
  /* Universal Filter Bar */
  .universal-filters{
    display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;
    background:var(--panel);border:1px solid var(--border);
    border-radius:14px;padding:10px 12px;margin-bottom:12px;
    box-shadow:var(--shadow);
  }
  .filter-group{display:flex;flex-direction:column;gap:4px;min-width:140px}
  .filter-group label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
  .filter-group input[type="text"],
  .filter-group select{padding:8px 10px;font-size:14px;min-height:36px}
  .filter-group input[type="checkbox"]{margin:0;cursor:pointer}
  .checkbox-label{display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;padding-top:8px}
  .checkbox-label span{font-size:14px;color:var(--fg);font-weight:500}
  #btnClearFilters{margin-left:auto;align-self:flex-end;height:36px;font-size:12px}
  @media (max-width:900px){
    .filter-group{min-width:120px}
    .universal-filters{gap:8px}
  }
  select,input[type="text"],input[type="date"],textarea{
    width:100%;padding:12px 16px;border-radius:12px;
    border:1px solid var(--border);background:var(--card);color:var(--fg);
    font-size:15px;font-weight:var(--font-weight-regular);
    transition:all 0.2s var(--transition);
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
  }
  
  /* Custom select styling for Safari and all browsers */
  select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 44px;
    cursor: pointer;
  }
  
  /* Dark mode select arrow */
  @media (prefers-color-scheme: dark) {
    select, .todoRow .statusSel, .todoRow .projectSel {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2398989d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    }
  }
  
  select:focus,input:focus,textarea:focus{
    outline:none;border-color:var(--acc);
    box-shadow:0 0 0 4px color-mix(in oklab,var(--acc) 15%,transparent);
  }
  
  /* Enhanced select hover state */
  select:hover {
    border-color:color-mix(in oklab,var(--acc) 40%,transparent);
    background-color:color-mix(in oklab,var(--card) 96%,var(--acc));
  }
  label{
    font-size:13px;color:var(--muted);display:block;margin-bottom:8px;
    font-weight:var(--font-weight-medium);letter-spacing:0.01em;
  }
  .pill{
    display:inline-flex;align-items:center;gap:8px;padding:8px 16px;
    border-radius:20px;background:#d9feaf;border:1px solid rgba(0,0,0,0.1);
    font-size:13px;font-weight:var(--font-weight-medium);
    transition:all 0.2s var(--transition);
    color:#000;
  }
  .pill:hover{background:#c8f49f;border-color:rgba(0,0,0,0.15);transform:translateY(-1px)}
  .pill .dot{width:8px;height:8px;border-radius:999px;background:currentColor}
  .badge{
    font-size:13px;padding:6px 12px;border-radius:16px;
    border:1px solid var(--border);background:var(--panel);
    font-weight:var(--font-weight-medium);
    font-family: inherit;
  }
  .status-todo{background:color-mix(in oklab,var(--muted) 8%,transparent)}
  .status-in-progress{background:color-mix(in oklab,var(--acc) 12%,transparent);color:var(--acc)}
  .status-waiting{background:color-mix(in oklab,var(--warn) 12%,transparent);color:var(--warn)}
  .status-review{background:color-mix(in oklab,var(--warn) 15%,transparent);color:var(--warn)}
  .status-done{background:color-mix(in oklab,var(--ok) 15%,transparent);color:var(--ok)}
  .muted{color:var(--muted)} 
  .note{font-size:13px;color:var(--muted);font-weight:var(--font-weight-regular)}
  .toolbar{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px;
    background:#e85b5b;padding:12px 20px;border-radius:16px;
    box-shadow:var(--shadow-medium);
  }
  .toolbar .note{color:rgba(255,255,255,0.9)}
  .action{
    background:#d9feaf!important;color:#000!important;
    border-color:rgba(0,0,0,0.1)!important;
    box-shadow:var(--shadow-medium);
  }
  .action:hover{
    background:#c8f49f!important;
    transform:translateY(-1px);
    box-shadow:var(--shadow-heavy);
  }

  /* Compact Todos with hover expansion */
  .list-todos{
    display:grid;
    gap:2px;
    margin-top:16px;
  }
  .todoRow{
    background:var(--card);
    border-radius:8px;
    padding:8px 16px;
    display:grid;
    gap:12px;
    align-items:center;
    grid-template-columns: 60px 1fr 100px 100px 100px;
    cursor:pointer;
    transition:all 0.25s var(--transition);
    border:1px solid transparent;
    box-shadow:none;
    position:relative;
    z-index:1;
  }
  .todoRow:hover{
    background:color-mix(in oklab,var(--card) 92%,var(--acc));
    border-color:color-mix(in oklab,var(--acc) 25%,transparent);
    box-shadow:var(--shadow-medium);
    border-radius:12px;
    padding:12px 16px;
    margin:-4px 0;
    z-index:10;
    transform:scale(1.02);
  }
  .todoHeader{
    border-bottom:1px solid var(--border);background:var(--panel);
    padding:12px 16px;display:grid;gap:12px;align-items:center;
    grid-template-columns: 60px 1fr 100px 100px 100px;
    font-size:13px;color:var(--muted);
  }
  .todoRow .statusSel{
    width:100%;font-size:13px;border-radius:10px;padding:8px 12px;
    font-weight:var(--font-weight-regular) !important;
    border:1px solid var(--border);background:var(--panel);
    transition:all 0.2s var(--transition);
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3c/polyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 12px;
    padding-right: 28px;
    cursor: pointer;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif !important;
  }
  .todoRow .projectSel{
    width:100%;font-size:13px;border-radius:10px;padding:8px 12px;
    font-weight:var(--font-weight-medium);
    border:1px solid var(--border);background:var(--panel);
    transition:all 0.2s var(--transition);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 12px;
    padding-right: 28px;
    cursor: pointer;
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
  }
  .title-cell{
    display:flex;align-items:center;
  }
  
  .todoRow .title{
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    font-weight:var(--font-weight-semibold);font-size:15px;
    line-height:1.4;
    display:inline-block;
    min-width:fit-content;
    cursor:text;
  }
  .todoRow .title[contenteditable="true"]{
    outline:2px solid transparent;border-radius:8px;padding:4px 8px;
    transition:all 0.2s var(--transition);
  }
  .todoRow .title:focus{
    outline:2px solid var(--acc);
    background:color-mix(in oklab,var(--acc) 8%, transparent);
    box-shadow:0 0 0 4px color-mix(in oklab,var(--acc) 15%,transparent);
  }
  
  .meta-text{
    font-size:13px;
    color:var(--muted);
    font-weight:var(--font-weight-regular);
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .project-name[contenteditable="true"]{outline:2px dashed transparent;border-radius:6px;padding:2px 4px;display:inline-block}
  .project-name:focus{outline:2px dashed var(--acc);background:color-mix(in oklab,var(--acc) 8%, transparent)}
  .todoRow .actions{display:flex;gap:6px;justify-content:flex-end}
  
  @media (max-width:900px){ 
    .todoRow{
      grid-template-columns:1fr;
      gap:8px;padding:16px;
    } 
    .todoRow .actions{justify-content:flex-start}
    .todoHeader{display:none}
    .wrap{padding:clamp(8px,2vw,16px)}
    .panel{margin-top:16px;padding:16px;border-radius:16px}
    .fab{width:56px;height:56px;right:16px;bottom:16px;font-size:28px}
    
    /* Mobile layout for todo items */
    .todoRow .meta-text{
      font-size:12px;
      margin:2px 0;
    }
    .title-cell{
      order:-1;
      margin-bottom:8px;
    }
  }

  /* HIU color code - compact portrait bars */
  .hiu{
    display:inline-flex;
    align-items:center;
    gap:0;
  }
  .hiu .d{
    width:12px;
    height:18px;
    border:none;
    background:var(--border);
    display:block;
    transition:all 0.2s var(--transition);
    cursor:pointer;
    position:relative;
  }
  .hiu .d:first-child{
    border-radius:3px 0 0 3px;
  }
  .hiu .d:last-child{
    border-radius:0 3px 3px 0;
  }
  .hiu .d:only-child{
    border-radius:3px;
  }
  .hiu .d:hover{
    transform:scaleY(1.1);
    z-index:1;
  }
  
  /* Hover feedback for inactive indicators */
  .hiu .d:not(.on):hover{
    background:color-mix(in oklab,var(--border) 70%,var(--fg));
    box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--fg) 30%,transparent);
  }
  .hiu .d.h:not(.on):hover{
    background:color-mix(in oklab,var(--impact) 15%,var(--border));
    box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--impact) 40%,transparent);
  }
  .hiu .d.i:not(.on):hover{
    background:color-mix(in oklab,var(--important) 15%,var(--border));
    box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--important) 40%,transparent);
  }
  .hiu .d.u:not(.on):hover{
    background:color-mix(in oklab,var(--urgent) 15%,var(--border));
    box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--urgent) 40%,transparent);
  }
  
  /* Active state styles */
  .hiu .d.h.on{
    background:var(--impact);
  }
  .hiu .d.i.on{
    background:var(--important);
  }
  .hiu .d.u.on{
    background:var(--urgent);
  }

  .list{display:grid;gap:16px;margin-top:20px}
  .card{
    border:1px solid var(--border);background:var(--card);
    border-radius:16px;padding:20px;display:grid;gap:12px;
    box-shadow:var(--shadow-light);
    transition:all 0.3s var(--transition);
  }
  .card[data-pid]{cursor:pointer}
  .card[data-pid]:hover{
    background:color-mix(in oklab,var(--card) 92%,var(--acc));
    transform:translateY(-4px);
    box-shadow:var(--shadow-heavy);
    border-color:color-mix(in oklab,var(--acc) 25%,transparent);
  }
  .card[kb]{cursor:pointer}
  .card[kb]:hover{
    background:color-mix(in oklab,var(--card) 92%,var(--acc));
    transform:translateY(-4px);
    box-shadow:var(--shadow-heavy);
  }
  .cardhead{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .cardtitle{font-weight:var(--font-weight-bold);font-size:17px;letter-spacing:-0.01em}
  .inline-list{font-size:12px;color:var(--muted)}
  .inline-list .item{display:inline}.inline-list .sep{opacity:.5;margin:0 6px}
  
  /* People view improvements */
  .people-section{margin-top:8px}
  .people-section-title{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:6px}
  .task-count{background:var(--panel);border:1px solid var(--border);border-radius:999px;font-size:10px;padding:1px 5px;font-weight:600}
  .chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
  .person-compact{padding:8px!important}
  .person-actions{display:flex;gap:4px;align-items:center}

  /* Kanban Board - Clean Rhythmic Spacing */
  .grid-boards{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:20px;
    margin-top:24px;
  }
  @media (max-width:1200px){.grid-boards{grid-template-columns:repeat(3,1fr);gap:18px}}
  @media (max-width:900px){.grid-boards{grid-template-columns:1fr 1fr;gap:16px}}
  @media (max-width:560px){.grid-boards{grid-template-columns:1fr;gap:16px}}
  
  .column{
    background:var(--panel);
    border:2px dashed var(--border);
    border-radius:16px;
    padding:20px;
    min-height:200px;
    transition:all 0.3s var(--transition);
    display:flex;
    flex-direction:column;
  }
  .column:hover{
    border-color:color-mix(in oklab,var(--acc) 40%,transparent);
    background:color-mix(in oklab,var(--panel) 96%,var(--acc));
    transform:translateY(-2px);
    box-shadow:var(--shadow-medium);
  }
  
  .colhead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom:1px solid var(--border);
    font-weight:var(--font-weight-bold);
    font-size:16px;
    letter-spacing:-0.01em;
  }
  
  .coltools{
    display:flex;
    gap:8px;
    align-items:center;
  }
  
  .dropzone{
    flex:1;
    min-height:120px;
    border-radius:12px;
    transition:all 0.3s var(--transition);
    padding:8px;
  }
  .dropzone.over{
    outline:3px solid var(--acc);
    outline-offset:4px;
    background:color-mix(in oklab,var(--acc) 8%,transparent);
    transform:scale(1.02);
  }
  
  /* Kanban Toolbar - Organized Layout */
  .kanban-toolbar{
    display:flex;
    justify-content:space-between;
    align-items:end;
    gap:24px;
    flex-wrap:wrap;
    background:#e85b5b !important;
  }
  
  .kanban-toolbar-group{
    display:flex;
    align-items:end;
    gap:12px;
  }
  
  .kanban-control{
    display:flex;
    flex-direction:column;
    gap:8px;
    min-width:140px;
  }
  
  .kanban-control label{
    font-size:12px;
    font-weight:var(--font-weight-medium);
    color:rgba(255,255,255,0.9);
    margin-bottom:0;
  }
  
  .kanban-control select{
    font-size:14px;
    padding:8px 12px;
    background:#d9feaf;
    color:#000;
    border:1px solid rgba(0,0,0,0.1);
    border-radius:8px;
  }
  
  @media (max-width:640px){
    .kanban-toolbar{
      flex-direction:column;
      align-items:stretch;
      gap:16px;
    }
    .kanban-toolbar-group{
      justify-content:space-between;
    }
    .kanban-control{
      min-width:120px;
    }
  }
  
  /* Kanban Cards - Much Smaller Typography */
  .card[kb] {
    padding: 12px;
    gap: 8px;
  }
  
  .card[kb] .cardhead {
    gap: 8px;
    margin-bottom: 0;
  }
  
  .card[kb] .cardtitle {
    font-size: 12px;
    font-weight: var(--font-weight-medium);
    line-height: 1.3;
  }
  
  .card[kb] .toolbar {
    margin-top: 8px;
    gap: 6px;
    flex-wrap: wrap;
  }
  
  .card[kb] .pill {
    font-size: 10px;
    padding: 4px 8px;
    gap: 4px;
    border-radius: 12px;
  }
  
  .card[kb] .pill .dot {
    width: 6px;
    height: 6px;
  }
  
  .card[kb] .badge {
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 8px;
    font-weight: var(--font-weight-regular);
  }
  
  /* Drag and Drop Visual Feedback */
  .card[kb].dragging {
    opacity: 0.5;
    transform: rotate(3deg);
    box-shadow: var(--shadow-heavy);
  }
  
  .card[kb].drag-over {
    border-top: 3px solid var(--acc);
    transform: translateY(2px);
  }
  
  .dropzone.over {
    background: color-mix(in oklab,var(--acc) 8%,transparent) !important;
  }

  .fab{
    position:fixed;right:24px;bottom:24px;z-index:20;
    width:64px;height:64px;border-radius:20px;
    background:#d9feaf;
    color:#000;border:2px solid rgba(0,0,0,0.1);box-shadow:var(--shadow-float);
    font-size:32px;display:grid;place-items:center;
    transition:all 0.3s var(--transition);
  }
  .fab:hover{
    transform:translateY(-4px) scale(1.05);
    box-shadow:0 20px 50px rgba(217,254,175,0.6);
    background:#c8f49f;
  }
  .fab:active{transform:translateY(-2px) scale(1.02)}

  dialog{
    border:none;padding:0;border-radius:24px;width:min(860px,94vw);
    background:var(--panel);color:var(--fg);
    box-shadow:var(--shadow-float);
    backdrop-filter:blur(20px);
  }
  dialog::backdrop{
    background:rgba(0,0,0,.4);
    backdrop-filter:blur(8px);
  }
  .modal{padding:32px} 
  .modal h3{
    margin:0 0 24px 0;font-size:24px;
    font-weight:var(--font-weight-bold);
    letter-spacing:-0.02em;
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  .tiny{font-size:13px;font-weight:var(--font-weight-regular)}
  .xbtn{
    border:none;background:transparent;font-size:14px;color:var(--muted);
    cursor:pointer;transition:all 0.2s var(--transition);
    border-radius:8px;padding:4px 8px;
  }
  .xbtn:hover{background:color-mix(in oklab,var(--muted) 10%,transparent);color:var(--fg)}

  /* Additional premium touches */
  * {
    -webkit-tap-highlight-color: transparent;
  }
  
  html {
    scroll-behavior: smooth;
  }
  
  ::selection {
    background: color-mix(in oklab,var(--acc) 20%,transparent);
  }
  
  /* Subtle page transitions */
  body {
    animation: pageLoad 0.6s var(--transition);
  }
  
  @keyframes pageLoad {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Enhanced focus states for accessibility */
  button:focus-visible, select:focus-visible {
    outline: 2px solid var(--acc);
    outline-offset: 2px;
  }
  
  /* Improved loading states */
  .loading {
    opacity: 0.7;
    pointer-events: none;
    transition: opacity 0.3s var(--transition);
  }

  /* Smooth scrollbar styling for webkit browsers */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg);
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--muted);
    border-radius: 4px;
    opacity: 0.6;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: var(--fg);
    opacity: 0.8;
  }

  /* Canvas View - Spatial Organization */
  #canvasContainer{
    position:relative;
    width:100%;
    height:800px;
    background:var(--bg-secondary);
    border-radius:16px;
    overflow:hidden;
    border:1px solid var(--border);
  }
  
  #mainCanvas{
    display:block;
    cursor:grab;
    background:radial-gradient(circle at 20px 20px, var(--muted) 1px, transparent 1px);
    background-size:40px 40px;
    touch-action:none; /* Prevent default touch behaviors */
  }
  
  #mainCanvas:active{
    cursor:grabbing;
  }
  
  .canvas-viewport{
    position:relative;
    transform-origin:0 0;
    transition:transform 0.1s ease-out;
  }
  
  .canvas-entity{
    position:absolute;
    padding:12px 16px;
    background:var(--bg);
    border:1px solid var(--border);
    border-radius:12px;
    cursor:move;
    user-select:none;
    font-size:14px;
    line-height:1.4;
    box-shadow:var(--shadow-medium);
    transition:all 0.2s var(--transition);
    min-width:120px;
    max-width:240px;
  }
  
  .canvas-entity:hover{
    box-shadow:var(--shadow-heavy);
    transform:translateY(-2px);
    border-color:var(--accent);
  }
  
  .canvas-entity.dragging{
    box-shadow:var(--shadow-float);
    transform:rotate(2deg) scale(1.05);
    z-index:1000;
  }
  
  .canvas-entity.todo{
    border-left:4px solid var(--accent);
  }
  
  .canvas-entity.project{
    border-left:4px solid var(--success);
    background:color-mix(in oklab,var(--success) 5%,var(--bg));
  }
  
  .canvas-entity-title{
    font-weight:600;
    color:var(--text);
    margin-bottom:4px;
  }
  
  .canvas-entity-meta{
    font-size:12px;
    color:var(--muted);
    opacity:0.8;
  }

  /* Command palette - refined */
  .kbar{
    position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;
    background:rgba(0,0,0,.4);backdrop-filter:blur(8px);z-index:50;
  }
  .kbar.open{display:flex;animation:fadeIn 0.3s var(--transition)}
  .kpanel{
    margin-top:12vh;width:min(760px,94vw);background:var(--panel);
    border:1px solid var(--border);border-radius:20px;
    box-shadow:var(--shadow-float);
    overflow:hidden;
  }
  .khead{padding:20px;border-bottom:1px solid var(--border)}
  .khead input{
    width:100%;padding:16px 20px;border-radius:16px;
    border:1px solid var(--border);background:var(--card);color:var(--fg);
    font-size:16px;font-weight:var(--font-weight-regular);
  }
  .khead input:focus{
    outline:none;border-color:var(--acc);
    box-shadow:0 0 0 4px color-mix(in oklab,var(--acc) 15%,transparent);
  }
  .klist{max-height:50vh;overflow:auto}
  .kitem{
    padding:16px 20px;border-top:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;
    transition:all 0.2s var(--transition);cursor:pointer;
  }
  .kitem:hover,.kitem.sel{
    background:color-mix(in oklab,var(--acc) 10%, transparent);
  }
  
  @keyframes fadeIn{
    from{opacity:0;transform:scale(0.95)}
    to{opacity:1;transform:scale(1)}
  }

</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo">JW</div>
      <div>
        <div style="font-weight:var(--font-weight-bold);font-size:17px;letter-spacing:-0.02em">Work Dashboard</div>
        <div class="tiny muted" style="font-weight:var(--font-weight-medium);opacity:0.8">Beautifully organized</div>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="todos">Todos</button>
      <button class="tab" data-tab="projects">Projects</button>
      <button class="tab" data-tab="people">People</button>
      <button class="tab" data-tab="kanban">Kanban</button>
      <button class="tab" data-tab="canvas">Canvas</button>
    </div>
    <div class="rightbar">
      <input type="file" id="fileImport" accept="application/json" class="hidden">
    </div>
  </div>
</header>

<!-- Universal Filter Bar -->
<div class="wrap" style="padding-top:8px;padding-bottom:0">
  <div class="universal-filters">
    <div class="filter-group">
      <label>Search</label>
      <input type="text" id="globalSearch" placeholder="Search anything‚Ä¶">
    </div>
    <div class="filter-group">
      <label>Project</label>
      <select id="globalProject">
        <option value="">All projects</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Person</label>
      <select id="globalPerson">
        <option value="">All people</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Status</label>
      <select id="globalStatus">
        <option value="">Any status</option>
        <option value="todo">Todo</option>
        <option value="in-progress">In Progress</option>
        <option value="waiting">Waiting</option>
        <option value="review">Review</option>
        <option value="done">Done</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="checkbox-label">
        <input type="checkbox" id="globalDueToday">
        <span>Due Today</span>
      </label>
    </div>
    <div class="filter-group">
      <label class="checkbox-label">
        <input type="checkbox" id="globalOverdue">
        <span>Overdue</span>
      </label>
    </div>
    <div class="filter-group">
      <label class="checkbox-label">
        <input type="checkbox" id="globalShowArchived">
        <span>Show Archived</span>
      </label>
    </div>
    <button class="pill" id="btnClearFilters" title="Clear all filters"><i class="fas fa-times"></i> Clear</button>
  </div>
</div>

<main class="wrap">
  <!-- TODOS -->
  <section id="view-todos" class="panel">
    <div class="filters">
      <div><label>Sort</label>
        <select id="fSort">
          <option value="created-desc">Created ‚Üì</option>
          <option value="due-asc">Due ‚Üë</option>
          <option value="due-desc">Due ‚Üì</option>
          <option value="priority-desc">Priority (HIU) ‚Üì</option>
          <option value="priority-asc">Priority (HIU) ‚Üë</option>
          <option value="status-asc">Status A‚ÜíZ</option>
          <option value="project-asc">Project A‚ÜíZ</option>
          <option value="project-desc">Project Z‚ÜíA</option>
          <option value="title-asc">Title A‚ÜíZ</option>
        </select>
      </div>
    </div>
    <div class="toolbar">
      <span class="note" id="countInfo"></span>
      <button class="pill action" id="btnCreateCanvasFromTodos" title="Create canvas from visible todos"><i class="fas fa-project-diagram"></i> Create Canvas</button>
    </div>
    <div class="list-todos" id="todoList"></div>
  </section>

  <!-- PROJECTS -->
  <section id="view-projects" class="panel hidden">
    <div class="toolbar"><button class="iconbtn action" id="btnAddProject" title="Add project"><i class="fas fa-plus"></i></button>
      <span class="note">Inline, ultra-compact todos per project.</span></div>
    <div class="list" id="projectList"></div>
  </section>

  <!-- PEOPLE -->
  <section id="view-people" class="panel hidden">
    <div class="toolbar"><button class="iconbtn action" id="btnAddPerson" title="Add person"><i class="fas fa-plus"></i></button>
      <span class="note">Attach existing tasks; tap √ó to remove.</span></div>
    <div class="list" id="peopleList"></div>
  </section>

  <!-- KANBAN -->
  <section id="view-kanban" class="panel hidden">
    <div class="toolbar kanban-toolbar">
      <div class="kanban-toolbar-group">
        <div class="kanban-control">
          <label class="tiny muted">Board</label>
          <select id="kbSelect"></select>
        </div>
        <button class="iconbtn" id="btnEditBoard" title="Edit board"><i class="fas fa-cog"></i></button>
      </div>
      <div class="kanban-toolbar-group">
        <div class="kanban-control">
          <label class="tiny muted">Filter by project</label>
          <select id="kbProject"><option value="">All</option></select>
        </div>
        <button class="iconbtn action" id="btnAddBoard" title="New board"><i class="fas fa-plus"></i></button>
      </div>
    </div>
    <div class="grid-boards" id="kanbanGrid"></div>
  </section>

  <!-- CANVAS -->

  <section id="view-canvas" class="hidden" style="padding:0;margin:0;border:none;background:none;">
    <div id="canvasContainer" style="position:relative;width:100%;height:calc(100vh - 80px);border-radius:0;box-shadow:none;padding:0;margin:0;background:var(--bg-secondary);border:none;">
      <canvas id="mainCanvas" width="1200" height="800" style="display:block;width:100%;height:100%;background:radial-gradient(circle at 20px 20px, var(--muted) 1px, transparent 1px);background-size:40px 40px;"></canvas>
      <div class="canvas-viewport" id="canvasViewport"></div>
      <div class="canvas-toolbar-floating" style="position:absolute;top:24px;right:24px;z-index:10;display:flex;gap:12px;align-items:center;border-radius:16px;box-shadow:var(--shadow-float);padding:12px 20px;">
        <select id="canvasViewSelect">
          <option value="default">Default Canvas</option>
        </select>
        <button class="iconbtn action" id="btnAddCanvasView" title="Add canvas view"><i class="fas fa-plus"></i></button>
        <button class="iconbtn delete-btn" id="btnDeleteCanvasView" title="Delete current canvas" style="display:none;"><i class="fas fa-trash"></i></button>
        <button class="iconbtn" id="btnAddTodoToCanvas" title="Add todo to canvas"><i class="fas fa-sticky-note"></i></button>
        <button class="iconbtn" id="btnAddProjectToCanvas" title="Add project to canvas"><i class="fas fa-folder"></i></button>
        <button class="iconbtn" id="btnAddAllTodos" title="Add all remaining todos"><i class="fas fa-list-check"></i></button>
        <button class="iconbtn" id="btnArrangeEntities" title="Auto-arrange entities"><i class="fas fa-grip-vertical"></i></button>
        <button class="iconbtn" id="btnFitToContent" title="Fit to content"><i class="fas fa-compress-arrows-alt"></i></button>
        <button class="iconbtn" id="btnCanvasReset" title="Reset view to top left"><i class="fas fa-home"></i></button>
        <button class="iconbtn" id="btnCanvasFullscreen" title="Toggle fullscreen"><i class="fas fa-expand"></i></button>
      </div>
    </div>
  </section>
</main>

<button class="fab" id="fabAdd" title="Add todo"><i class="fas fa-plus"></i></button>

<!-- MODAL: ADD/EDIT TODO -->
<dialog id="dlgTodo">
  <form method="dialog" class="modal" id="todoForm">
    <h3 id="todoFormTitle">New Todo</h3>
    <div class="row">
      <div><label>Title</label><input type="text" id="tTitle" required></div>
      <div><label>Project</label><select id="tProject"></select></div>
    </div>
    <div class="row">
      <div><label>Due date</label><input type="date" id="tDue"></div>
      <div><label>Status</label><select id="tStatus">
        <option value="todo">Todo</option><option value="in-progress">In Progress</option>
        <option value="waiting">Waiting</option><option value="review">Review</option>
        <option value="done">Done</option></select></div>
    </div>
    <div>
      <label>Eisenhower (H/I/U)</label>
      <div class="hiu" id="eisenForm">
        <span class="d h" data-k="impact" title="High impact"></span>
        <span class="d i" data-k="important" title="Important"></span>
        <span class="d u" data-k="urgent" title="Urgent"></span>
      </div>
    </div>
    <div><label>Tags (comma separated)</label><input type="text" id="tTags" placeholder="design, api, review"></div>
    <div><label>Notes</label><textarea id="tNotes" rows="3" placeholder="Optional details‚Ä¶"></textarea></div>
    <div class="row">
      <div><label>I‚Äôm waiting on‚Ä¶ (multi-select)</label><select id="selWaitingOn" multiple size="6"></select>
        <div class="tiny muted" style="margin-top:4px">üí° Ctrl+click to deselect items ¬∑ <button type="button" id="btnClearWaitingOn" style="background:none;border:none;color:var(--acc);cursor:pointer;font-size:11px">Clear all</button></div></div>
      <div><label>They‚Äôre waiting on me‚Ä¶ (multi-select)</label><select id="selWaitingOnMe" multiple size="6"></select>
        <div class="tiny muted" style="margin-top:4px">üí° Ctrl+click to deselect items ¬∑ <button type="button" id="btnClearWaitingOnMe" style="background:none;border:none;color:var(--acc);cursor:pointer;font-size:11px">Clear all</button></div></div>
    </div>
    <div class="toolbar" style="justify-content:space-between;background:transparent;padding:0;margin-top:20px">
      <div style="display:flex;gap:8px">
        <button id="btnArchiveTodo" type="button" class="pill" style="background:#6c757d;color:#fff;border-color:transparent;"><i class="fas fa-archive"></i> Archive</button>
        <button id="btnUnarchiveTodo" type="button" class="pill" style="background:#30d158;color:#fff;border-color:transparent;display:none"><i class="fas fa-undo"></i> Unarchive</button>
        <button id="btnDeleteTodo" type="button" class="pill" style="background:#ff3b30;color:#fff;border-color:transparent;display:none"><i class="fas fa-trash"></i> Delete</button>
      </div>
      <div style="display:flex;gap:8px">
        <button value="cancel" class="pill">Cancel</button>
        <button id="btnSaveTodo" value="default" class="pill action">Save</button>
      </div>
    </div>
    <input type="hidden" id="tId">
  </form>
</dialog>

<!-- MODAL: ADD PROJECT -->
<dialog id="dlgProject">
  <form method="dialog" class="modal" id="projectForm">
    <h3>New Project</h3>
    <div class="row">
      <div><label>Name</label><input type="text" id="pName" required></div>
      <div><label>Color</label><input type="color" id="pColor" value="#7cc9ff"></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnSaveProject" value="default" class="pill action">Save</button>
    </div>
  </form>
</dialog>

<!-- MODAL: ADD PERSON -->
<dialog id="dlgPerson">
  <form method="dialog" class="modal" id="personForm">
    <h3>New Person</h3>
    <div class="row">
      <div><label>Name</label><input type="text" id="sName" required></div>
      <div><label>Initials</label><input type="text" id="sInit" placeholder="AB" maxlength="3"></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnSavePerson" value="default" class="pill action">Save</button>
    </div>
  </form>
</dialog>

<!-- MODAL: ATTACH EXISTING TASKS -->
<dialog id="dlgAttach">
  <form method="dialog" class="modal" id="attachForm">
    <h3 id="attachTitle">Attach tasks</h3>
    <div class="filters">
      <div><label>Search</label><input type="text" id="aSearch" placeholder="Search anything‚Ä¶"></div>
      <div><label>Project</label><select id="aProject"><option value="">All projects</option></select></div>
      <div><label>Person</label><select id="aPerson"><option value="">All people</option></select></div>
      <div><label>Status</label><select id="aStatus"><option value="">Any</option><option value="todo">Todo</option><option value="in-progress">In Progress</option><option value="waiting">Waiting</option><option value="review">Review</option><option value="done">Done</option></select></div>
    </div>
    <div class="toolbar">
      <div><label class="tiny muted">Sort by</label>
        <select id="aSort">
          <option value="due-asc">Due ‚Üë</option><option value="due-desc">Due ‚Üì</option>
          <option value="priority-desc">Priority ‚Üì</option><option value="priority-asc">Priority ‚Üë</option>
          <option value="created-desc">Created ‚Üì</option><option value="title-asc">Title A‚ÜíZ</option>
        </select>
      </div>
      <span class="note" id="aCount"></span>
    </div>
    <div class="list-todos" id="attachList"></div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnAttachConfirm" value="default" class="pill action">Attach</button>
    </div>
  </form>
</dialog>

<!-- MODAL: EDIT BOARD (rename + custom columns) -->
<dialog id="dlgBoard">
  <form method="dialog" class="modal" id="boardForm">
    <h3>Edit Board</h3>
    <div><label>Name</label><input type="text" id="bName"></div>
    <div style="margin-top:8px">
      <label>Columns</label>
      <div id="bCols"></div>
      <div class="toolbar"><button class="pill action" id="btnAddCol" type="button">Add column</button></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnSaveBoard" value="default" class="pill action">Save</button>
    </div>
  </form>
</dialog>

<!-- MODAL: DELETE PROJECT -->
<dialog id="dlgDeleteProject">
  <form method="dialog" class="modal" id="deleteProjectForm">
    <h3>Delete Project</h3>
    <div style="margin-bottom:16px">
      <div style="padding:12px;background:color-mix(in oklab,var(--warn) 10%,transparent);border:1px solid color-mix(in oklab,var(--warn) 30%,transparent);border-radius:12px;margin-bottom:12px">
        <strong>‚ö†Ô∏è Warning:</strong> You are about to delete "<span id="deleteProjectName"></span>".
      </div>
      <p style="margin:8px 0">What should happen to the <strong><span id="deleteTodoCount"></span></strong> assigned to this project?</p>
      
      <div style="margin:12px 0">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="radio" name="deleteMode" value="unassign" checked>
          <span><strong>Unassign todos</strong> (recommended)<br><small class="muted">Todos will remain but be unassigned from this project</small></span>
        </label>
      </div>
      
      <div style="margin:12px 0">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="radio" name="deleteMode" value="reassign" id="reassignRadio">
          <span><strong>Reassign to another project</strong><br><small class="muted">Move all todos to a different project</small></span>
        </label>
        <div style="margin-top:8px;margin-left:32px" id="reassignProjectContainer">
          <select id="reassignProjectSelect" style="width:100%" disabled>
            <option value="">Select target project...</option>
          </select>
        </div>
      </div>
      
      <!-- Collapsible dangerous option -->
      <details style="margin-top:16px">
        <summary style="cursor:pointer;color:var(--bad);font-size:12px;padding:4px 0">‚ö†Ô∏è Show destructive option</summary>
        <div style="margin-top:8px;padding:12px;background:color-mix(in oklab,var(--bad) 8%,transparent);border:1px solid color-mix(in oklab,var(--bad) 30%,transparent);border-radius:8px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="deleteMode" value="deleteTodos">
            <span style="color:var(--bad)"><strong>Delete all todos in this project</strong><br><small>‚ö†Ô∏è This action cannot be undone!</small></span>
          </label>
        </div>
      </details>
    </div>
    
    <div class="toolbar" style="justify-content:space-between">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnConfirmDeleteProject" value="default" class="pill" style="background:var(--bad);color:#fff;border-color:transparent">Delete Project</button>
    </div>
    <input type="hidden" id="deleteProjectId">
  </form>
</dialog>

<!-- COMMAND PALETTE -->
<div class="kbar" id="kbar" aria-hidden="true">
  <div class="kpanel">
    <div class="khead"><input id="kinput" placeholder="Type a command‚Ä¶ (e.g. new, go kanban, filter status:todo)"/></div>
    <div class="klist" id="klist"></div>
  </div>
</div>

<script>
/*** ====== DATA ====== ***/
const LS_KEY='jwdm_v1';
const demoData=()=>({
  meta:{version:3,lastId:100},
  current:{
    tab:'todos',
    sort:'due-asc',
    activeKanbanId:'default',
    filters:{
      search:'',
      project:'',
      person:'',
      sort:'due-asc'
    }
  },
  todos:{
    1:{id:'1',title:'Finalize wireframes',notes:'Homepage + pricing',projectId:'p1',people:[],tags:['design'],due:dateStrOffset(2),created:Date.now()-86400000*2,status:'in-progress',eisen:{impact:1,important:1,urgent:0}},
    2:{id:'2',title:'API auth flow',notes:'Add refresh tokens',projectId:'p1',people:['a'],tags:['api','security'],due:dateStrOffset(5),created:Date.now()-86400000*3,status:'todo',eisen:{impact:1,important:0,urgent:1}},
    3:{id:'3',title:'Client feedback pass',notes:'Summarize and triage',projectId:'p2',people:['b'],tags:['pm'],due:dateStrOffset(1),created:Date.now()-86400000,status:'review',eisen:{impact:1,important:1,urgent:1}},
    4:{id:'4',title:'Billing bugfix',notes:'Rounding issue',projectId:'p1',people:['c'],tags:['bug'],due:dateStrOffset(0),created:Date.now()-3600*1000,status:'in-progress',eisen:{impact:1,important:0,urgent:1}},
    5:{id:'5',title:'Write release notes',notes:'',projectId:'p2',people:[],tags:['docs'],due:'',created:Date.now(),status:'todo',eisen:{impact:1,important:0,urgent:0}}
  },
  projects:{ p1:{id:'p1',name:'LaunchPad',color:'#7cc9ff',todoIds:['1','2','4']}, p2:{id:'p2',name:'Client Alpha',color:'#ffd36b',todoIds:['3','5']} },
  people:{
    a:{id:'a',name:'Alex',initials:'AX',waitingForMe:['2'],waitingForThem:['3']},
    b:{id:'b',name:'Bea',initials:'BE',waitingForMe:['3'],waitingForThem:[]},
    c:{id:'c',name:'Chris',initials:'CH',waitingForMe:['4'],waitingForThem:[]}
  },
  kanbans:{
    kb1:{id:'kb1',name:'Default',columns:[
      {id:'col-backlog',name:'Backlog',todoIds:['5']},
      {id:'col-progress',name:'In Progress',todoIds:['1','4']},
      {id:'col-review',name:'Review',todoIds:['3']},
      {id:'col-done',name:'Done',todoIds:[]}
    ]}
  },
  canvasViews:{
    default:{
      id:'default',
      name:'Default Canvas',
      entities:{
        // Per-view positioning: entityType:entityId -> {x, y}
        // Example: 'todo:1': {x: 150, y: 200}
      }
    }
  }
});
function dateStrOffset(days){const d=new Date(Date.now()+days*86400000);return d.toISOString().slice(0,10);} 

// ====== SINGLE SOURCE OF TRUTH ======
// These objects are derived from store data and provide a universal interface

const STATUS_DEFINITIONS = [
  { id: 'todo', label: 'Todo', order: 0 },
  { id: 'in-progress', label: 'In Progress', order: 1 },
  { id: 'waiting', label: 'Waiting', order: 2 },
  { id: 'review', label: 'Review', order: 3 },
  { id: 'done', label: 'Done', order: 4 }
];

// Universal computed data - this is what views consume
// Contains filtered and sorted data based on global filters
const viewData = {
  todos: [],        // Filtered/sorted todos
  projects: [],     // Filtered/sorted projects
  people: [],       // Filtered/sorted people
  statuses: [],     // Available statuses (derived from STATUS_DEFINITIONS)
  projectsMap: {},  // Map of projectId -> project
  peopleMap: {}     // Map of personId -> person
};

let store=load();
function load(){try{const raw=localStorage.getItem(LS_KEY);if(!raw){const d=demoData();localStorage.setItem(LS_KEY,JSON.stringify(d));return structuredClone(d);}
  const data = JSON.parse(raw);
  // Ensure backwards compatibility for view state
  if (!data.current) data.current = {};
  if (!data.current.filters) data.current.filters = {sort:'due-asc'};
  if (!data.current.globalFilters) data.current.globalFilters = {
    search: '', project: '', person: '', status: '', 
    dueToday: false, overdue: false, showArchived: false
  };
  if (!data.canvasViews) data.canvasViews = {
    default: { id: 'default', name: 'Default Canvas', entities: {} }
  };
  return data;
}catch(e){
  console.error('Failed to load data:', e);
  // Create backup before overwriting
  const backup = localStorage.getItem(LS_KEY);
  if(backup) {
    const backupKey = LS_KEY + '_backup_' + Date.now();
    localStorage.setItem(backupKey, backup);
    console.warn('Corrupted data backed up to:', backupKey);
    alert('‚ö†Ô∏è Data load error! A backup was saved. Check console and export your data immediately.');
  }
  const d=demoData();
  localStorage.setItem(LS_KEY,JSON.stringify(d));
  return structuredClone(d);
}}
function save(){
  const timestamp = new Date().toISOString();
  const dataToSave = {...store, _lastSaved: timestamp, _saveCount: (store._saveCount || 0) + 1};
  localStorage.setItem(LS_KEY, JSON.stringify(dataToSave));
  
  // Log saves for debugging
  if(window.DEBUG_SAVES) {
    console.log(`[${timestamp}] Save #${dataToSave._saveCount} - Todos: ${Object.keys(store.todos).length}, Projects: ${Object.keys(store.projects).length}`);
  }
  
  // Auto-backup every 10 saves
  if(!window._saveCount) window._saveCount = 0;
  window._saveCount++;
  if(window._saveCount % 10 === 0) {
    const backupKey = LS_KEY + '_autobackup';
    localStorage.setItem(backupKey, JSON.stringify(dataToSave));
    console.log('Auto-backup saved at', timestamp);
  }
}

// Enable save debugging from console
window.debugSaves = function(enabled = true) {
  window.DEBUG_SAVES = enabled;
  console.log('Save debugging:', enabled ? 'enabled' : 'disabled');
};

// Show current data timestamp info
window.checkDataVersion = function() {
  console.log('=== Current Data Version ===');
  console.log('Save count:', store._saveCount || 'unknown');
  console.log('Last saved:', store._lastSaved || 'unknown');
  console.log('Todos:', Object.keys(store.todos).length);
  console.log('Projects:', Object.keys(store.projects).length);
  console.log('People:', Object.keys(store.people).length);
  console.log('\nTo see all backups: listBackups()');
};
function nextId(){store.meta.lastId++;return String(store.meta.lastId);} 

// Save and restore view state (now only sort remains in todos view)
function saveViewState() {
  if (!store.current) store.current = {};
  if (!store.current.filters) store.current.filters = {};
  
  store.current.filters = {
    sort: fSort?.value || 'due-asc'
  };
  save();
}

function restoreViewState() {
  if (!store.current?.filters) return;
  
  // Safety check - make sure filter elements exist
  if (!fSort) return;
  
  const filters = store.current.filters;
  if (filters.sort !== undefined) fSort.value = filters.sort;
}

function deleteTodo(id) {
  if (!id || !store.todos[id]) return false;
  
  // Remove from todos
  delete store.todos[id];
  
  // Remove from projects
  Object.values(store.projects).forEach(p => {
    if (p.todoIds?.includes(id)) {
      p.todoIds = p.todoIds.filter(tid => tid !== id);
    }
  });
  
  // Remove from people waiting lists
  Object.values(store.people).forEach(p => {
    if (p.waitingForMe?.includes(id)) {
      p.waitingForMe = p.waitingForMe.filter(tid => tid !== id);
    }
    if (p.waitingForThem?.includes(id)) {
      p.waitingForThem = p.waitingForThem.filter(tid => tid !== id);
    }
  });
  
  // Remove from kanban columns
  Object.values(store.kanbans).forEach(kb => {
    kb.columns.forEach(col => {
      if (col.todoIds?.includes(id)) {
        col.todoIds = col.todoIds.filter(tid => tid !== id);
      }
    });
  });
  
  save();
  return true;
}

/*** ====== HELPERS ====== ***/
const el=(q,r=document)=>r.querySelector(q), els=(q,r=document)=>Array.from(r.querySelectorAll(q));
function fmtDue(d){if(!d) return '‚Äî';const diff=(new Date(d)-new Date().setHours(0,0,0,0))/86400000;const days=Math.round(diff);
  if(days<0) return `‚ö† ${Math.abs(days)}d overdue`; if(days===0) return 'Today'; if(days===1) return 'Tomorrow'; return `in ${days}d`; }
const pColor=p=> '#'+(p.initials.charCodeAt(0)*99991 % 0xffffff).toString(16).padStart(6,'6f6f6f');
const score=t=> (t.eisen?.impact?4:0)+(t.eisen?.important?2:0)+(t.eisen?.urgent?1:0);
const projName= t=> store.projects[t.projectId]?.name || '';
const universalHaystack=t=>{
  const people=(t.people||[]).map(id=>store.people[id]?.name).filter(Boolean).join(' ');
  return [t.title,t.notes,(t.tags||[]).join(' '),t.status,score(t),t.id,t.due,projName(t),people].join(' ').toLowerCase();
};

/*** ====== NAV + IO ====== ***/
const tabs=el('#tabs');
const views=['todos','projects','people','kanban','canvas'];
function setTab(tab){views.forEach(id=>el('#view-'+id).classList.toggle('hidden',tab!==id)); store.current.tab=tab; save(); render(true);}

tabs.addEventListener('click',e=>{const b=e.target.closest('.tab'); if(!b) return; els('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); setTab(b.dataset.tab);});

// Backup functions
function exportBackup() {
  // Create and download backup
  const blob=new Blob([JSON.stringify(store,null,2)],{type:'application/json'});
  const a=document.createElement('a'); 
  a.href=URL.createObjectURL(blob); 
  a.download=`jwdm-backup-${new Date().toISOString().slice(0,10)}.json`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove();
  
  // Close command palette
  closeK();
}

function recoverAutoBackup() {
  const backupKey = LS_KEY + '_autobackup';
  const backup = localStorage.getItem(backupKey);
  
  if (!backup) {
    alert('No auto-backup found. Auto-backups are created every 10 saves.');
    closeK();
    return;
  }
  
  try {
    const data = JSON.parse(backup);
    if (!data.todos || !data.projects || !data.people) {
      throw new Error('Invalid backup data');
    }
    
    if (confirm('Restore from auto-backup? This will replace your current data. Current data will be exported first.')) {
      // Export current data first as safety
      exportBackup();
      
      // Wait a moment for download, then restore
      setTimeout(() => {
        store = data;
        save();
        render(true);
        alert('‚úÖ Auto-backup restored successfully!');
      }, 500);
    }
  } catch (e) {
    console.error('Recovery error:', e);
    alert('Failed to recover auto-backup: ' + e.message);
  }
  
  closeK();
}

// Helper function to list all available backups (accessible from console)
window.listBackups = function() {
  const backups = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith(LS_KEY)) {
      const data = localStorage.getItem(key);
      backups.push({
        key: key,
        size: (data.length / 1024).toFixed(2) + ' KB',
        preview: data.substring(0, 100)
      });
    }
  }
  console.table(backups);
  console.log('To recover a specific backup, use: recoverFromKey("key_name")');
  return backups;
};

window.recoverFromKey = function(key) {
  const data = localStorage.getItem(key);
  if (!data) {
    console.error('Backup not found:', key);
    return;
  }
  try {
    const parsed = JSON.parse(data);
    if (confirm('Restore from "' + key + '"? Current data will be exported first.')) {
      exportBackup();
      setTimeout(() => {
        store = parsed;
        save();
        render(true);
        console.log('‚úÖ Restored from:', key);
      }, 500);
    }
  } catch (e) {
    console.error('Invalid backup data:', e);
  }
};

el('#fileImport').addEventListener('change',e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const data=JSON.parse(r.result); if(!data.todos||!data.projects||!data.people) throw new Error('Invalid backup'); 
  // Ensure imported data has view state structure
  if (!data.current) data.current = {};
  if (!data.current.filters) data.current.filters = {search:'', project:'', person:'', sort:'due-asc'};
  if (!data.canvasViews) data.canvasViews = {
    default: { id: 'default', name: 'Default Canvas', entities: {} }
  };
  store=data; save(); render();}catch(err){alert('Import failed: '+err.message);}}; r.readAsText(f); e.target.value='';});

/*** ====== UNIVERSAL FILTERS ====== ***/
const globalSearch = el('#globalSearch');
const globalProject = el('#globalProject');
const globalPerson = el('#globalPerson');
const globalStatus = el('#globalStatus');
const globalDueToday = el('#globalDueToday');
const globalOverdue = el('#globalOverdue');
const globalShowArchived = el('#globalShowArchived');
const btnClearFilters = el('#btnClearFilters');

// Compute universal view data - single source of filtered/sorted data
// This runs once per render cycle and all views consume this data
function computeViewData() {
  // Update derived maps
  viewData.projectsMap = store.projects;
  viewData.peopleMap = store.people;
  viewData.statuses = STATUS_DEFINITIONS;
  
  // Start with all base data (unfiltered from store)
  let todos = Object.values(store.todos);
  let projects = Object.values(store.projects);
  let people = Object.values(store.people);
  
  // Apply archived filter globally (unless explicitly showing archived)
  if (!globalShowArchived.checked) {
    todos = todos.filter(t => !t.archived);
    projects = projects.filter(p => !p.archived);
    people = people.filter(p => !p.archived);
  }
  
  // Apply global filters
  const searchTerm = globalSearch.value.trim().toLowerCase();
  if (searchTerm) {
    todos = todos.filter(t => universalHaystack(t).includes(searchTerm));
    projects = projects.filter(p => (p.name || '').toLowerCase().includes(searchTerm));
    people = people.filter(p => (p.name || '').toLowerCase().includes(searchTerm));
  }
  
  // Project filter (only applies to todos)
  const projectId = globalProject.value;
  if (projectId) {
    todos = todos.filter(t => t.projectId === projectId);
  }
  
  // Person filter (only applies to todos)
  const personId = globalPerson.value;
  if (personId) {
    todos = todos.filter(t => (t.people || []).includes(personId));
  }
  
  // Status filter (only applies to todos)
  const status = globalStatus.value;
  if (status) {
    todos = todos.filter(t => t.status === status);
  }
  
  // Due Today filter (only applies to todos)
  if (globalDueToday.checked) {
    const today = new Date().toISOString().slice(0, 10);
    todos = todos.filter(t => t.due === today);
  }
  
  // Overdue filter (only applies to todos)
  if (globalOverdue.checked) {
    const today = new Date().setHours(0, 0, 0, 0);
    todos = todos.filter(t => t.due && new Date(t.due) < today);
  }
  
  // Store computed data
  viewData.todos = todos;
  viewData.projects = projects;
  viewData.people = people;
}

// Legacy function for backwards compatibility - now just filters archived
function applyGlobalFilters(items) {
  if (!globalShowArchived.checked) {
    return items.filter(item => !item.archived);
  }
  return items;
}

// Update global filter dropdowns from single source of truth
function updateGlobalFilters() {
  const curProj = globalProject.value;
  const curPerson = globalPerson.value;
  const curStatus = globalStatus.value;
  
  // Populate projects dropdown
  globalProject.innerHTML = `<option value="">All projects</option>` + 
    Object.values(store.projects)
      .filter(p => !p.archived || globalShowArchived.checked)
      .map(p => `<option value="${p.id}">${p.name}</option>`)
      .join('');
  
  // Populate people dropdown
  globalPerson.innerHTML = `<option value="">All people</option>` + 
    Object.values(store.people)
      .filter(p => !p.archived || globalShowArchived.checked)
      .map(p => `<option value="${p.id}">${p.name}</option>`)
      .join('');
  
  // Populate status dropdown from single source of truth
  globalStatus.innerHTML = `<option value="">Any status</option>` + 
    STATUS_DEFINITIONS
      .map(s => `<option value="${s.id}">${s.label}</option>`)
      .join('');
  
  // Restore previous selections
  globalProject.value = curProj;
  globalPerson.value = curPerson;
  globalStatus.value = curStatus;
}

// Save global filters to store
function saveGlobalFilters() {
  if (!store.current) store.current = {};
  store.current.globalFilters = {
    search: globalSearch.value,
    project: globalProject.value,
    person: globalPerson.value,
    status: globalStatus.value,
    dueToday: globalDueToday.checked,
    overdue: globalOverdue.checked,
    showArchived: globalShowArchived.checked
  };
  save();
}

// Restore global filters from store
function restoreGlobalFilters() {
  if (!store.current?.globalFilters) return;
  
  const gf = store.current.globalFilters;
  if (gf.search !== undefined) globalSearch.value = gf.search;
  if (gf.project !== undefined) globalProject.value = gf.project;
  if (gf.person !== undefined) globalPerson.value = gf.person;
  if (gf.status !== undefined) globalStatus.value = gf.status;
  if (gf.dueToday !== undefined) globalDueToday.checked = gf.dueToday;
  if (gf.overdue !== undefined) globalOverdue.checked = gf.overdue;
  if (gf.showArchived !== undefined) globalShowArchived.checked = gf.showArchived;
}

// Clear all filters
btnClearFilters.onclick = () => {
  globalSearch.value = '';
  globalProject.value = '';
  globalPerson.value = '';
  globalStatus.value = '';
  globalDueToday.checked = false;
  globalOverdue.checked = false;
  globalShowArchived.checked = false;
  
  saveGlobalFilters();
  render();
};

// Add event listeners to global filters - they trigger full re-render and save state
[globalSearch, globalProject, globalPerson, globalStatus, globalDueToday, globalOverdue, globalShowArchived].forEach(filter => {
  filter.addEventListener(filter.type === 'checkbox' ? 'change' : 'input', () => {
    saveGlobalFilters();
    render(); // Full re-render computes viewData and updates all views
  });
});

/*** ====== TODOS VIEW ====== ***/
const fSort=el('#fSort'), todoList=el('#todoList');
fSort.addEventListener('input',()=>{
  renderMainTodos();
  saveViewState();
});

const SORTS={
  'due-asc':(a,b)=> (a.due||'9999-12-31')<(b.due||'9999-12-31')?-1:1,
  'due-desc':(a,b)=> (a.due||'0000-01-01')>(b.due||'0000-01-01')?-1:1,
  'priority-desc':(a,b)=> score(b)-score(a),
  'priority-asc':(a,b)=> score(a)-score(b),
  'status-asc':(a,b)=> (a.status||'').localeCompare(b.status||''),
  'project-asc':(a,b)=> projName(a).localeCompare(projName(b)),
  'project-desc':(a,b)=> projName(b).localeCompare(projName(a)),
  'title-asc':(a,b)=> (a.title||'').localeCompare(b.title||''),
  'created-desc':(a,b)=> (b.created||0)-(a.created||0),
};

function renderMainTodos() {
  // Use pre-filtered data from viewData
  let items = [...viewData.todos];
  
  // Apply view-specific sorting
  const sorter = SORTS[fSort.value] || SORTS['due-asc'];
  items.sort(sorter);
  
  el('#countInfo').textContent = `${items.length} todos shown`;
  
  const header = `<div class="todoHeader">
    <div>Priority</div>
    <div>Title</div>
    <div>Status</div>
    <div>Project</div>
    <div>Due</div>
  </div>`;
  
  todoList.innerHTML = header + items.map(t => {
    const isLate = t.due && new Date(t.due) < new Date().setHours(0, 0, 0, 0);
    const dueClass = isLate ? 'style="color:var(--bad)"' : '';
    const project = store.projects[t.projectId];
    const archivedStyle = t.archived ? 'style="opacity:0.5"' : '';
    const archivedBadge = t.archived ? '<span class="badge" style="background:var(--muted);color:#fff;margin-left:8px">üóÑ Archived</span>' : '';
    
    return `<div class="todoRow" data-id="${t.id}" ${archivedStyle}>
      <div class="hiu" data-id="${t.id}">
        <span class="d h ${t.eisen?.impact ? 'on' : ''}" data-act="toggle" data-k="impact" title="High impact"></span>
        <span class="d i ${t.eisen?.important ? 'on' : ''}" data-act="toggle" data-k="important" title="Important"></span>
        <span class="d u ${t.eisen?.urgent ? 'on' : ''}" data-act="toggle" data-k="urgent" title="Urgent"></span>
      </div>
      <div class="title-cell">
        <span class="title" contenteditable="true" spellcheck="false" data-act="editTitle" data-id="${t.id}" title="Click to edit title">${t.title}</span>
        ${archivedBadge}
      </div>
      <div class="meta-text">${t.status}</div>
      <div class="meta-text">${project?.name || '‚Äî'}</div>
      <div class="meta-text" ${dueClass}>${t.due ? fmtDue(t.due) : '‚Äî'}</div>
    </div>`;
  }).join('');
  
  // Event listeners for main todos view
  todoList.onclick = e => {
    const id = e.target.dataset.id;
    if (e.target.dataset.act === 'toggle') {
      const k = e.target.dataset.k;
      const t = store.todos[e.target.closest('.hiu').dataset.id];
      t.eisen = t.eisen || {impact: 0, important: 0, urgent: 0};
      t.eisen[k] = t.eisen[k] ? 0 : 1;
      save();
      renderMainTodos();
    }
    
    // If clicking on a todo row but not on any specific control element, open the modal
    const todoRow = e.target.closest('.todoRow');
    if (todoRow && !e.target.dataset.act && !e.target.closest('select, input, button, .hiu .d, .title')) {
      const todoId = todoRow.dataset.id;
      if (todoId) {
        openTodoModal(todoId);
      }
    }
  };
  
  // Inline title edit
  todoList.addEventListener('keydown', (e) => {
    if (e.target.dataset.act === 'editTitle' && e.key === 'Enter') {
      e.preventDefault();
      e.target.blur();
    }
  });
  
  todoList.addEventListener('blur', (e) => {
    if (e.target.dataset.act === 'editTitle') {
      const id = e.target.dataset.id;
      const v = e.target.textContent.trim();
      store.todos[id].title = v || store.todos[id].title;
      save();
    }
  }, true);
}

const renderTodos = (items = [], container, {showProject=false, showPeople=false, showTags=false, showStatus=true, showDue=true}={}) => {
  const sorted = items.filter(t => !t.archived).sort((a, b) => {
    const aVal = Number(a.eisen?.impact) * 2 + Number(a.eisen?.important) + Number(a.eisen?.urgent);
    const bVal = Number(b.eisen?.impact) * 2 + Number(b.eisen?.important) + Number(b.eisen?.urgent);
    return bVal - aVal;
  });
  
  container.innerHTML = sorted.map(t => {
    const isLate = t.due && new Date(t.due) < new Date().setHours(0,0,0,0);
    const dueClass = isLate ? 'style="color:var(--bad)"' : '';
    const project = store.projects[t.projectId];
    const people = (t.people || []).map(pid => store.people[pid]).filter(Boolean);
    const tags = (t.tags || []).map(tag => `<span class="pill" style="background:var(--acc);color:#fff;border-color:transparent">${tag}</span>`).join(' ');
    
    return `<div class="todoRow" data-id="${t.id}">
      <div class="hiu" data-id="${t.id}">
        <span class="d h ${t.eisen?.impact?'on':''}" data-act="toggle" data-k="impact" title="High impact"></span>
        <span class="d i ${t.eisen?.important?'on':''}" data-act="toggle" data-k="important" title="Important"></span>
        <span class="d u ${t.eisen?.urgent?'on':''}" data-act="toggle" data-k="urgent" title="Urgent"></span>
      </div>
      <div class="title-cell">
        <span class="title" contenteditable="true" spellcheck="false" data-act="editTitle" data-id="${t.id}" title="Click to edit title">${t.title}</span>
      </div>
      <div class="meta-text">${t.status}</div>
      <div class="meta-text">${project?.name || '‚Äî'}</div>
      <div class="meta-text">${t.due ? fmtDue(t.due) : '‚Äî'}</div>
      <div class="actions"></div>
    </div>`;
  }).join('');

  // interactions
  container.onchange=e=>{
    const id=e.target.dataset.id; if(!id) return;
    if(e.target.dataset.act==='setStatus'){store.todos[id].status=e.target.value; save(); renderTodos();}
    if(e.target.dataset.act==='setProject'){
      const oldProjectId = store.todos[id].projectId;
      const newProjectId = e.target.value;
      
      // Update todo's project
      store.todos[id].projectId = newProjectId;
      
      // Remove from old project
      if(oldProjectId && store.projects[oldProjectId]) {
        const oldProject = store.projects[oldProjectId];
        oldProject.todoIds = (oldProject.todoIds || []).filter(tid => tid !== id);
      }
      
      // Add to new project
      if(newProjectId && store.projects[newProjectId]) {
        const newProject = store.projects[newProjectId];
        if(!newProject.todoIds) newProject.todoIds = [];
        if(!newProject.todoIds.includes(id)) {
          newProject.todoIds.push(id);
        }
      }
      
      save(); 
      renderTodos();
      renderProjects(); // Update project view to reflect changes
      renderKanban(); // Update kanban view in case todos moved
    }
  };
  container.onclick=e=>{
    const id=e.target.dataset.id;
    if(e.target.dataset.act==='openModal'){ openTodoModal(id); }
    if(e.target.dataset.act==='toggle'){
      const k=e.target.dataset.k; const t=store.todos[e.target.closest('.hiu').dataset.id]; t.eisen=t.eisen||{impact:0,important:0,urgent:0}; t.eisen[k]=t.eisen[k]?0:1; save(); renderTodos();
    }
    
    // If clicking on a todo row but not on any specific control element, open the modal
    const todoRow = e.target.closest('.todoRow');
    if (todoRow && !e.target.dataset.act && !e.target.closest('select, input, button, .hiu .d, .title')) {
      const todoId = todoRow.dataset.id;
      if (todoId) {
        openTodoModal(todoId);
      }
    }
  };
  // inline title edit
  container.addEventListener('keydown', (e)=>{ if(e.target.dataset.act==='editTitle' && e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});
  container.addEventListener('blur', (e)=>{ if(e.target.dataset.act==='editTitle'){ const id=e.target.dataset.id; const v=e.target.textContent.trim(); store.todos[id].title=v||store.todos[id].title; save(); } }, true);
}

/*** ====== PROJECTS VIEW ====== ***/
const projectList=el('#projectList');
el('#btnAddProject').onclick=()=>el('#dlgProject').showModal();
const saveProjectHandler = e=>{e.preventDefault(); const name=el('#pName').value.trim(); if(!name) return; const color=el('#pColor').value||'#7cc9ff'; const id='p'+nextId(); store.projects[id]={id,name,color,todoIds:[]}; save(); el('#dlgProject').close(); el('#projectForm').reset(); renderProjects(); renderTodos();};
el('#btnSaveProject').onclick=saveProjectHandler;
// Add Enter key handler for Project modal
el('#dlgProject').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    saveProjectHandler(e);
  }
});
function renderProjects(){
  // Use pre-filtered projects from viewData
  const projects = viewData.projects;
  
  projectList.innerHTML=projects.map(p=>{
    // Get todos for this project from the filtered viewData
    let todos = viewData.todos.filter(t => (p.todoIds || []).includes(t.id));
    
    const inline = todos.map((t,i)=>`<span class="item"><span class="link" data-act="open" data-id="${t.id}">${t.title}</span></span>${i<todos.length-1?'<span class="sep">¬∑</span>':''}`).join('');
    return `<div class="card" data-pid="${p.id}">
      <div class="cardhead">
        <div class="cardtitle"><span class="pill" style="background:${p.color};color:#000;border-color:transparent">‚óè</span> <span class="project-name" contenteditable="true" spellcheck="false" data-act="editProjectName" data-pid="${p.id}" title="Click to edit project name">${p.name}</span></div>
        <div style="display:flex;gap:6px">
          <button class="iconbtn action" data-pid="${p.id}" data-act="addToProject" title="Add todo here"><i class="fas fa-plus"></i></button>
          <button class="iconbtn" data-pid="${p.id}" data-act="deleteProject" title="Delete project" style="background:#ff3b30;color:#fff;border-color:transparent"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div class="inline-list">${inline || '<span class="note">No todos yet.</span>'}</div>
    </div>`;
  }).join('');
  projectList.onclick=e=>{ 
    if(e.target.dataset.act==='addToProject') openTodoModal(null,e.target.dataset.pid); 
    if(e.target.dataset.act==='open') openTodoModal(e.target.dataset.id); 
    if(e.target.dataset.act==='deleteProject') openDeleteProjectModal(e.target.dataset.pid);
    
    // If clicking on a project card but not on any specific control element, view the project
    const projectCard = e.target.closest('.card[data-pid]');
    if (projectCard && !e.target.dataset.act && !e.target.closest('button, .link[data-act="open"], .project-name')) {
      const projectId = projectCard.dataset.pid;
      if (projectId) {
        // Switch to todos view and filter by this project
        setTab('todos');
        globalProject.value = projectId;
        render();
      }
    }
  };
  
  // Inline project name editing
  projectList.addEventListener('keydown', (e) => {
    if (e.target.dataset.act === 'editProjectName' && e.key === 'Enter') {
      e.preventDefault();
      e.target.blur();
    }
  });
  
  projectList.addEventListener('blur', (e) => {
    if (e.target.dataset.act === 'editProjectName') {
      const projectId = e.target.dataset.pid;
      const newName = e.target.textContent.trim();
      
      if (newName && store.projects[projectId]) {
        store.projects[projectId].name = newName;
        save();
        renderProjects();
        renderTodos(); // Update project dropdowns in todo rows
        renderKanban(); // Update kanban view project names
        refreshProjectSelects(); // Update project selects in modals
      } else if (!newName) {
        // Revert to original name if empty
        renderProjects();
      }
    }
  }, true);
}

/*** ====== PEOPLE VIEW ====== ***/
const peopleList=el('#peopleList');
el('#btnAddPerson').onclick=()=>el('#dlgPerson').showModal();
const savePersonHandler = e=>{e.preventDefault(); const name=el('#sName').value.trim(); if(!name) return; const initials=(el('#sInit').value.trim()||name.split(/\s+/).map(s=>s[0]).join('').slice(0,3)).toUpperCase(); const id=initials.toLowerCase()+nextId(); store.people[id]={id,name,initials,waitingForMe:[],waitingForThem:[]}; save(); el('#dlgPerson').close(); el('#personForm').reset(); renderPeople(); renderTodos();};
el('#btnSavePerson').onclick=savePersonHandler;
// Add Enter key handler for Person modal
el('#dlgPerson').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    savePersonHandler(e);
  }
});

function openDeleteProjectModal(projectId) {
  const project = store.projects[projectId];
  if (!project) return;
  
  const todoIds = project.todoIds || [];
  const todoCount = todoIds.length;
  
  el('#deleteProjectId').value = projectId;
  el('#deleteProjectName').textContent = project.name;
  el('#deleteTodoCount').textContent = todoCount === 0 ? 'no todos' : 
    todoCount === 1 ? '1 todo' : `${todoCount} todos`;
  
  // Populate reassign dropdown with other projects
  const reassignSelect = el('#reassignProjectSelect');
  const otherProjects = Object.values(store.projects).filter(p => p.id !== projectId);
  reassignSelect.innerHTML = '<option value="">Select target project...</option>' +
    otherProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  
  // Reset form to default (unassign)
  el('input[name="deleteMode"][value="unassign"]').checked = true;
  reassignSelect.disabled = true;
  
  // Hide reassign option if no other projects exist
  const reassignContainer = el('#reassignProjectContainer').closest('div');
  reassignContainer.style.display = otherProjects.length > 0 ? 'block' : 'none';
  
  el('#dlgDeleteProject').showModal();
}

function deleteProject(projectId, mode, targetProjectId = null) {
  const project = store.projects[projectId];
  if (!project) return false;
  
  const todoIds = project.todoIds || [];
  
  if (mode === 'deleteTodos') {
    // Delete all todos in this project
    todoIds.forEach(todoId => {
      deleteTodo(todoId);
    });
  } else if (mode === 'reassign' && targetProjectId) {
    // Reassign todos to another project
    const targetProject = store.projects[targetProjectId];
    if (!targetProject) return false;
    
    todoIds.forEach(todoId => {
      if (store.todos[todoId]) {
        store.todos[todoId].projectId = targetProjectId;
        // Add to target project's todo list
        if (!targetProject.todoIds.includes(todoId)) {
          targetProject.todoIds.push(todoId);
        }
      }
    });
  } else {
    // Unassign todos from project
    todoIds.forEach(todoId => {
      if (store.todos[todoId]) {
        store.todos[todoId].projectId = '';
      }
    });
  }
  
  // Delete the project itself
  delete store.projects[projectId];
  
  save();
  return true;
}

const deleteProjectHandler = e => {
  e.preventDefault();
  const projectId = el('#deleteProjectId').value;
  const mode = el('input[name="deleteMode"]:checked').value;
  const targetProjectId = el('#reassignProjectSelect').value;
  
  const project = store.projects[projectId];
  const todoCount = (project?.todoIds || []).length;
  
  // Validation for reassign mode
  if (mode === 'reassign' && !targetProjectId) {
    alert('Please select a target project to reassign todos to.');
    return;
  }
  
  let confirmMsg;
  if (mode === 'deleteTodos') {
    confirmMsg = `Are you sure you want to delete "${project.name}" and permanently delete all ${todoCount} todos?\n\nThis action cannot be undone!`;
  } else if (mode === 'reassign') {
    const targetProject = store.projects[targetProjectId];
    confirmMsg = `Delete "${project.name}" and move ${todoCount} todos to "${targetProject.name}"?`;
  } else {
    confirmMsg = `Delete "${project.name}"?\n\n${todoCount > 0 ? `${todoCount} todos will be unassigned but kept.` : 'No todos to unassign.'}`;
  }
  
  if (confirm(confirmMsg)) {
    if (deleteProject(projectId, mode, targetProjectId)) {
      el('#dlgDeleteProject').close();
      renderProjects();
      renderTodos();
      renderKanban();
      
      // Clear global project filter if it was set to the deleted project
      if (globalProject.value === projectId) {
        globalProject.value = '';
        saveGlobalFilters();
        render();
      }
    }
  }
};

el('#btnConfirmDeleteProject').onclick = deleteProjectHandler;

// Handle radio button changes for delete mode
el('#dlgDeleteProject').addEventListener('change', e => {
  if (e.target.name === 'deleteMode') {
    const reassignSelect = el('#reassignProjectSelect');
    const isReassign = e.target.value === 'reassign';
    reassignSelect.disabled = !isReassign;
    if (!isReassign) {
      reassignSelect.value = '';
    }
  }
});

// Add Enter key handler for Delete Project modal  
el('#dlgDeleteProject').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    deleteProjectHandler(e);
  }
});
function recomputeTodoPeople(todoId){const ids=Object.values(store.people).filter(p=>(p.waitingForMe||[]).includes(todoId)||(p.waitingForThem||[]).includes(todoId)).map(p=>p.id); const t=store.todos[todoId]; if(t) t.people=[...new Set(ids)];}
function renderPeople(){
  // Use pre-filtered people from viewData
  let people = [...viewData.people];
  
  // Sort people: most tasks first, no tasks last
  const sortedPeople = people.sort((a, b) => {
    const aTotal = (a.waitingForMe?.length || 0) + (a.waitingForThem?.length || 0);
    const bTotal = (b.waitingForMe?.length || 0) + (b.waitingForThem?.length || 0);
    
    // If one has tasks and the other doesn't, prioritize the one with tasks
    if (aTotal === 0 && bTotal > 0) return 1;
    if (bTotal === 0 && aTotal > 0) return -1;
    
    // If both have tasks or both have no tasks, sort by total count (descending)
    return bTotal - aTotal;
  });
  
  peopleList.innerHTML=sortedPeople.map(p=>{
    // Filter waiting lists to only include todos in viewData (respects global filters)
    const viewTodoIds = new Set(viewData.todos.map(t => t.id));
    const waitingForMe = (p.waitingForMe || []).filter(id => viewTodoIds.has(id));
    const waitingForThem = (p.waitingForThem || []).filter(id => viewTodoIds.has(id));
    const totalTasks = waitingForMe.length + waitingForThem.length;
    
    const taskPill = (tid, side) => {
      const t = store.todos[tid];
      if (!t) return '';
      const isOverdue = t.due && new Date(t.due) < new Date().setHours(0,0,0,0);
      const dueClass = isOverdue ? 'style="color:var(--bad)"' : '';
      return `<span class="pill" data-pid="${p.id}" data-side="${side}" data-tid="${tid}">
        <span class="link" data-act="open" data-id="${t.id}">${t.title}</span>
        ${t.due ? `<span ${dueClass}>¬∑${fmtDue(t.due)}</span>` : ''}
        <button class="xbtn" title="Remove">√ó</button>
      </span>`;
    };
    
    if (totalTasks === 0) {
      // Ultra-compact view for people with no tasks
      return `<div class="card person-compact">
        <div class="cardhead">
          <div class="cardtitle">
            <span class="pill" style="background:${pColor(p)};color:#000;border-color:transparent">${p.initials}</span> 
            ${p.name}
          </div>
          <div class="person-actions">
            <button class="pill action" data-pid="${p.id}" data-act="addWithPerson" title="New todo for ${p.name}" style="font-size:11px;padding:3px 8px">+ Task</button>
            <button class="pill" data-pid="${p.id}" data-side="waitingForMe" data-act="openAttach" title="Attach existing tasks" style="font-size:11px;padding:3px 8px">Attach</button>
          </div>
        </div>
      </div>`;
    }
    
    // Improved compact view for people with tasks
    return `<div class="card">
      <div class="cardhead">
        <div class="cardtitle" title="${p.id}"><span class="pill" style="background:${pColor(p)};color:#000;border-color:transparent">${p.initials}</span> ${p.name}</div>
        <div class="coltools"><button class="iconbtn action" data-pid="${p.id}" data-act="addWithPerson" title="New todo for ${p.name}">Ôºã</button></div>
      </div>
      <div class="row">
        <div>
          <div class="tiny muted">I‚Äôm waiting on them</div>
          <div class="toolbar"><button class="pill action" data-pid="${p.id}" data-side="waitingForMe" data-act="openAttach">Attach tasks</button></div>
          <div class="chips">${waitingForMe.map(id => taskPill(id, 'waitingForMe')).join('')}</div>
        </div>
        <div>
          <div class="tiny muted">They‚Äôre waiting on me</div>
          <div class="toolbar"><button class="pill action" data-pid="${p.id}" data-side="waitingForThem" data-act="openAttach">Attach tasks</button></div>
          <div class="chips">${waitingForThem.map(id => taskPill(id, 'waitingForThem')).join('')}</div>
        </div>
      </div>
    </div>`;
  }).join('');

  peopleList.onclick=e=>{
    const act=e.target.dataset.act;
    if(act==='addWithPerson'){ openTodoModal(null,null,e.target.dataset.pid); return; }
    if(act==='openAttach'){ openAttachModal({type:'person', personId:e.target.dataset.pid, side:e.target.dataset.side}); return; }
    if(act==='open') openTodoModal(e.target.dataset.id);
    if(e.target.classList.contains('xbtn')){ const wrap=e.target.closest('.pill'); const pid=wrap.dataset.pid, side=wrap.dataset.side, tid=wrap.dataset.tid; const p=store.people[pid]; p[side]=p[side].filter(id=>id!==tid); recomputeTodoPeople(tid); save(); renderPeople(); renderTodos(); renderKanban(); }
  };
}

/*** ====== KANBAN ====== ***/
const kbSelect=el('#kbSelect'), kbProject=el('#kbProject'), kanbanGrid=el('#kanbanGrid');
el('#btnAddBoard').onclick=()=>{ const name=prompt('Board name?'); if(!name) return; const id='kb'+nextId(); store.kanbans[id]={id,name,columns:[{id:'col-'+nextId(),name:'Backlog',todoIds:[]}]}; store.current.activeKanbanId=id; save(); renderKanban(); };
kbSelect.onchange=()=>{store.current.activeKanbanId=kbSelect.value; save(); updateBoardControls(); renderKanban();};
kbProject.onchange=()=>renderKanban();

el('#btnEditBoard').onclick=()=>openBoardEditor();

function updateBoardControls() {
  const isDefaultBoard = store.current.activeKanbanId === 'default';
  el('#btnEditBoard').style.display = isDefaultBoard ? 'none' : '';
}

let pendingPlacement=null;

function renderKanban(){
  const boards=Object.values(store.kanbans);
  const allBoards = [{id:'default', name:'Default (By Status)'}].concat(boards);
  
  kbSelect.innerHTML=allBoards.map(k=>`<option value="${k.id}" ${store.current.activeKanbanId===k.id?'selected':''}>${k.name}</option>`).join('');
  if(!store.current.activeKanbanId){store.current.activeKanbanId='default'; save();}
  kbProject.innerHTML=`<option value="">All</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

  const filterProj=kbProject.value;
  const isDefaultBoard = store.current.activeKanbanId === 'default';
  
  if (isDefaultBoard) {
    // Special handling for the default board - show todos by status using STATUS_DEFINITIONS
    const statusColumns = STATUS_DEFINITIONS.map(s => ({
      id: s.id,
      name: s.label,
      status: s.id
    }));
    
    kanbanGrid.innerHTML = statusColumns.map(col => {
      // Use viewData filtered todos, then apply board-specific project filter
      let todos = viewData.todos.filter(t => t.status === col.status && (!filterProj || t.projectId === filterProj));
      
      const cards = todos.map(t => kanbanCard(t)).join('');
      return `<div class="column" data-col="${col.id}">
        <div class="colhead">
          <span>${col.name}</span>
          <div class="coltools">
            <span class="badge">${todos.length}</span>
          </div>
        </div>
        <div class="dropzone" data-col="${col.id}">${cards || '<div class="note">No todos here‚Ä¶</div>'}</div>
      </div>`;
    }).join('');
  } else {
    // Regular board handling
    const kb=store.kanbans[store.current.activeKanbanId];
    if (!kb) return;
    
    kanbanGrid.innerHTML=kb.columns.map(col=>{
      // Use viewData filtered todos, then apply column and project filters
      const columnTodoIds = new Set(col.todoIds);
      let todos = viewData.todos.filter(t => columnTodoIds.has(t.id) && (!filterProj || t.projectId === filterProj));
      
      const cards = todos.map(t=>kanbanCard(t)).join('');
      return `<div class="column" data-col="${col.id}">
        <div class="colhead">
          <span contenteditable="true" spellcheck="false" data-act="renameCol" data-col="${col.id}" title="Click to rename">${col.name}</span>
          <div class="coltools">
            <button class="pill action" data-col="${col.id}" data-act="attachToCol" title="Attach existing"><i class="fas fa-plus"></i></button>
            <button class="pill action" data-col="${col.id}" data-act="newToCol" title="New todo here"><i class="fas fa-file-medical"></i></button>
            <button class="pill" data-col="${col.id}" data-act="deleteCol" title="Delete column" style="background:#ff3b30;color:#fff"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="dropzone" data-col="${col.id}">${cards||'<div class="note">Drop here‚Ä¶</div>'}</div>
      </div>`;
    }).join('');
  }

  // Enhanced drag and drop with within-column sorting
  els('.card[kb]').forEach(c=>{ 
    c.draggable=true; 
    c.addEventListener('dragstart',ev=>{
      ev.dataTransfer.setData('text/plain',c.dataset.id); 
      c.classList.add('dragging'); 
      ev.dataTransfer.effectAllowed='move';
    }); 
    c.addEventListener('dragend',()=>c.classList.remove('dragging'));
    
    // Allow dropping on cards for reordering within column
    c.addEventListener('dragover',ev=>{
      if(c.classList.contains('dragging')) return;
      ev.preventDefault();
      c.classList.add('drag-over');
    });
    c.addEventListener('dragleave',()=>c.classList.remove('drag-over'));
    c.addEventListener('drop',ev=>{
      if(c.classList.contains('dragging')) return;
      ev.preventDefault();
      ev.stopPropagation();
      c.classList.remove('drag-over');
      const todoId=ev.dataTransfer.getData('text/plain');
      const targetId=c.dataset.id;
      moveInKanban(todoId, c.closest('.dropzone').dataset.col, targetId);
    });
  });
  
  els('.dropzone').forEach(z=>{ 
    z.addEventListener('dragover',ev=>{
      ev.preventDefault(); 
      z.classList.add('over');
    }); 
    z.addEventListener('dragleave',()=>z.classList.remove('over')); 
    z.addEventListener('drop',ev=>{
      ev.preventDefault(); 
      z.classList.remove('over'); 
      const todoId=ev.dataTransfer.getData('text/plain'); 
      moveInKanban(todoId,z.dataset.col);
    }); 
  });

  // inline column rename
  kanbanGrid.addEventListener('keydown', (e)=>{ if(e.target.dataset.act==='renameCol' && e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});
  kanbanGrid.addEventListener('blur', (e)=>{ if(e.target.dataset.act==='renameCol'){ const colId=e.target.dataset.col; const kb=store.kanbans[store.current.activeKanbanId]; const col=kb.columns.find(c=>c.id===colId); if(col){ col.name=e.target.textContent.trim()||col.name; save(); } } }, true);

  // delete column button
  kanbanGrid.addEventListener('click', (e)=>{ if(e.target.dataset.act==='deleteCol'){ const colId=e.target.dataset.col; const kb=store.kanbans[store.current.activeKanbanId]; if(kb.columns.length<=1) return alert('Need at least one column'); const i=kb.columns.findIndex(c=>c.id===colId); if(i>=0){ kb.columns.splice(i,1); save(); renderKanban(); } } });
  
  updateBoardControls();
}
function kanbanCard(t){ const p=store.projects[t.projectId]; return `<div class="card" kb data-id="${t.id}" data-act="openModal" style="cursor:pointer" title="Click to edit todo"><div class="cardhead"><div class="cardtitle tiny">${t.title}</div></div><div class="toolbar"><span class="pill"><span class="dot" style="color:${p?.color||'var(--muted)'}"></span>${p?.name||'‚Äî'}</span><span class="badge">${fmtDue(t.due)}</span><span class="badge">${t.status}</span></div></div>`; }
function moveInKanban(todoId, toColId, targetTodoId = null){ 
  const isDefaultBoard = store.current.activeKanbanId === 'default';
  
  if (isDefaultBoard) {
    // For default board, update the todo's status
    const statusMap = {'todo': 'todo', 'in-progress': 'in-progress', 'waiting': 'waiting', 'review': 'review', 'done': 'done'};
    if (statusMap[toColId] && store.todos[todoId]) {
      store.todos[todoId].status = statusMap[toColId];
      save();
      renderKanban();
      renderTodos(); // Also update todos view since status changed
    }
  } else {
    // Regular board handling with position support
    const kb = store.kanbans[store.current.activeKanbanId]; 
    const sourceCol = kb.columns.find(c => c.todoIds.includes(todoId));
    const targetCol = kb.columns.find(c => c.id === toColId); 
    
    if (!targetCol) return;
    
    // Remove from source column
    if (sourceCol) {
      const sourceIndex = sourceCol.todoIds.indexOf(todoId);
      if (sourceIndex >= 0) sourceCol.todoIds.splice(sourceIndex, 1);
    }
    
    // Add to target column at specific position
    if (targetTodoId && targetCol.todoIds.includes(targetTodoId)) {
      // Insert before the target todo
      const targetIndex = targetCol.todoIds.indexOf(targetTodoId);
      targetCol.todoIds.splice(targetIndex, 0, todoId);
    } else {
      // Add to end if no specific target or target not found
      if (!targetCol.todoIds.includes(todoId)) {
        targetCol.todoIds.push(todoId);
      }
    }
    
    save(); 
    renderKanban();
  }
}
kanbanGrid.addEventListener('click',e=>{ 
  if(e.target.dataset.act==='edit' || e.target.dataset.act==='openModal') {
    openTodoModal(e.target.dataset.id); 
  }
  
  // Check if clicked element is a kanban card or inside one
  const cardElement = e.target.closest('[kb]');
  if(cardElement && cardElement.dataset.id && !e.target.closest('button')) {
    openTodoModal(cardElement.dataset.id);
  }
  
  // Disable these actions for default board
  if (store.current.activeKanbanId !== 'default') {
    if(e.target.dataset.act==='attachToCol'){ openAttachModal({type:'kanban', boardId:store.current.activeKanbanId, colId:e.target.dataset.col}); } 
    if(e.target.dataset.act==='newToCol'){ pendingPlacement={boardId:store.current.activeKanbanId, colId:e.target.dataset.col}; openTodoModal(); }
  }
});

function openBoardEditor(){ 
  if (store.current.activeKanbanId === 'default') return; // Can't edit default board
  const kb=store.kanbans[store.current.activeKanbanId]; if(!kb) return; el('#bName').value=kb.name; const holder=el('#bCols'); holder.innerHTML = kb.columns.map(c=> `<div class="row" data-col="${c.id}"><div><input type="text" value="${c.name}" data-act="colName"></div><div><button class="pill" data-act="colUp"><i class="fas fa-arrow-up"></i></button> <button class="pill" data-act="colDown"><i class="fas fa-arrow-down"></i></button> <button class="pill" data-act="colDel" style="background:#ff3b30;color:#fff"><i class="fas fa-trash"></i></button></div></div>`).join(''); el('#dlgBoard').showModal();
}
el('#btnAddCol').onclick=()=>{ const kb=store.kanbans[store.current.activeKanbanId]; const id='col-'+nextId(); kb.columns.push({id,name:'New Column',todoIds:[]}); save(); openBoardEditor(); };
const saveBoardHandler = (e)=>{ e.preventDefault(); const kb=store.kanbans[store.current.activeKanbanId]; kb.name = el('#bName').value.trim()||kb.name; // names
  els('#bCols .row').forEach(r=>{ const id=r.dataset.col; const col=kb.columns.find(c=>c.id===id); if(col){ col.name = el('input[data-act="colName"]', r).value.trim()||col.name; }}); save(); el('#dlgBoard').close(); renderKanban(); };
el('#btnSaveBoard').onclick=saveBoardHandler;
// Add Enter key handler for Board modal
el('#dlgBoard').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    saveBoardHandler(e);
  }
});
el('#bCols')?.addEventListener('click',(e)=>{ const kb=store.kanbans[store.current.activeKanbanId]; const row=e.target.closest('.row'); if(!row) return; const id=row.dataset.col; const i=kb.columns.findIndex(c=>c.id===id); if(e.target.dataset.act==='colUp' && i>0){ const [c]=kb.columns.splice(i,1); kb.columns.splice(i-1,0,c); openBoardEditor(); }
  if(e.target.dataset.act==='colDown' && i<kb.columns.length-1){ const [c]=kb.columns.splice(i,1); kb.columns.splice(i+1,0,c); openBoardEditor(); }
  if(e.target.dataset.act==='colDel'){ if(kb.columns.length<=1) return alert('Need at least one column'); kb.columns.splice(i,1); openBoardEditor(); }
});

/*** ====== TODO MODAL ====== ***/
const dlgTodo=el('#dlgTodo');
const tId=el('#tId'), tTitle=el('#tTitle'), tNotes=el('#tNotes'), tProject=el('#tProject'), tDue=el('#tDue'), tStatus=el('#tStatus'), selWaitingOn=el('#selWaitingOn'), selWaitingOnMe=el('#selWaitingOnMe'), eisenForm=el('#eisenForm');
el('#fabAdd').onclick=()=>openTodoModal();

// Close dialogs when clicking on backdrop
els('dialog').forEach(dialog => {
  dialog.addEventListener('click', (e) => {
    if (e.target === dialog) {
      dialog.close();
    }
  });
});

function setEisenUI(e){ els('.d', eisenForm).forEach(b=>{ const k=b.dataset.k; b.classList.toggle('on', !!e[k]); }); }
eisenForm.addEventListener('click', (ev)=>{ const btn=ev.target.closest('.d'); if(!btn) return; btn.classList.toggle('on'); });
function openTodoModal(id=null,presetProjectId=null,presetPersonId=null){ 
  refreshProjectSelects(); refreshPeopleSelects(); 
  if(id){ 
    const t=store.todos[id]; 
    tId.value=t.id; tTitle.value=t.title||''; tNotes.value=t.notes||''; tProject.value=t.projectId||''; tDue.value=t.due||''; tStatus.value=t.status||'todo'; 
    const waitingOnIds=Object.values(store.people).filter(p=>p.waitingForMe?.includes(id)).map(p=>p.id); 
    const waitingOnMeIds=Object.values(store.people).filter(p=>p.waitingForThem?.includes(id)).map(p=>p.id); 
    setMultiSel(selWaitingOn,new Set(waitingOnIds)); setMultiSel(selWaitingOnMe,new Set(waitingOnMeIds)); 
    setEisenUI(t.eisen||{impact:0,important:0,urgent:0}); 
    el('#todoFormTitle').textContent='Edit Todo'; 
  el('#btnDeleteTodo').style.display='block';
  el('#btnArchiveTodo').style.display = t.archived ? 'none' : 'inline-block';
  el('#btnUnarchiveTodo').style.display = t.archived ? 'inline-block' : 'none';
  }else{ 
    tId.value=''; el('#todoForm').reset(); tProject.value=presetProjectId||''; 
    setMultiSel(selWaitingOn,new Set(presetPersonId?[presetPersonId]:[])); setMultiSel(selWaitingOnMe,new Set()); 
    setEisenUI({impact:0,important:0,urgent:0}); 
    el('#todoFormTitle').textContent='New Todo'; 
  el('#btnDeleteTodo').style.display='none';
  el('#btnArchiveTodo').style.display = 'none';
  el('#btnUnarchiveTodo').style.display = 'none';
  } 
  dlgTodo.showModal(); 
}
function refreshProjectSelects(){ const opts=`<option value="">(none)</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); tProject.innerHTML=opts; el('#aProject').innerHTML=`<option value="">All projects</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); el('#kbProject').innerHTML=`<option value="">All</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
function refreshPeopleSelects(){ const options=Object.values(store.people).map(p=>`<option value="${p.id}">${p.name} (${p.initials})</option>`).join(''); selWaitingOn.innerHTML=options; selWaitingOnMe.innerHTML=options; el('#aPerson').innerHTML=`<option value="">All people</option>`+Object.values(store.people).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
function setMultiSel(selectEl,set){Array.from(selectEl.options).forEach(o=>o.selected=set.has(o.value));}
function getMultiSel(selectEl){return Array.from(selectEl.selectedOptions).map(o=>o.value);} 
const saveTodoHandler = e=>{ e.preventDefault(); const isEdit=!!tId.value; const id=isEdit?tId.value:nextId(); const projectId=tProject.value||''; const waitingOn=new Set(getMultiSel(selWaitingOn)); const waitingOnMe=new Set(getMultiSel(selWaitingOnMe)); const ev=[...els('.d',eisenForm)].reduce((a,b)=>{a[b.dataset.k]=b.classList.contains('on')?1:0;return a;},{impact:0,important:0,urgent:0}); const archived = isEdit ? store.todos[id].archived || false : false; const todo={id,title:tTitle.value.trim(),notes:tNotes.value.trim(),projectId, people:[...new Set([...waitingOn,...waitingOnMe])], tags:(el('#tTags')?.value||'').split(',').map(s=>s.trim()).filter(Boolean), eisen:ev, due:tDue.value||'',status:tStatus.value,created:isEdit?store.todos[id].created:Date.now(), archived }; store.todos[id]=todo; Object.values(store.projects).forEach(p=>{const has=p.todoIds?.includes(id); if(p.id===projectId && !has){(p.todoIds||(p.todoIds=[])).push(id);} if(p.id!==projectId && has){p.todoIds.splice(p.todoIds.indexOf(id),1);} }); Object.values(store.people).forEach(p=>{ p.waitingForMe=(p.waitingForMe||[]).filter(tid=>tid!==id); p.waitingForThem=(p.waitingForThem||[]).filter(tid=>tid!==id); if(waitingOn.has(p.id)) (p.waitingForMe||=[]).push(id); if(waitingOnMe.has(p.id)) (p.waitingForThem||=[]).push(id); }); if(pendingPlacement && !isEdit){ moveInKanban(id, pendingPlacement.colId); pendingPlacement=null; } save(); dlgTodo.close(); render(true); };
el('#btnSaveTodo').onclick=saveTodoHandler;

// Archive/Unarchive handlers
el('#btnArchiveTodo').onclick = e => {
  e.preventDefault();
  const id = tId.value;
  if (!id || !store.todos[id]) return;
  store.todos[id].archived = true;
  save();
  dlgTodo.close();
  render(true);
};
el('#btnUnarchiveTodo').onclick = e => {
  e.preventDefault();
  const id = tId.value;
  if (!id || !store.todos[id]) return;
  store.todos[id].archived = false;
  save();
  dlgTodo.close();
  render(true);
};

// Clear multi-select handlers
el('#btnClearWaitingOn').onclick = () => {
  Array.from(el('#selWaitingOn').options).forEach(option => option.selected = false);
};

el('#btnClearWaitingOnMe').onclick = () => {
  Array.from(el('#selWaitingOnMe').options).forEach(option => option.selected = false);
};

// Delete todo handler
el('#btnDeleteTodo').onclick = e => {
  e.preventDefault();
  const id = tId.value;
  if (!id) return;
  
  const todo = store.todos[id];
  const confirmMsg = `Are you sure you want to delete "${todo?.title || 'this todo'}"?\n\nThis action cannot be undone.`;
  
  if (confirm(confirmMsg)) {
    deleteTodo(id);
    dlgTodo.close();
    render(true);
  }
};

// Add Enter key handler for Todo modal
dlgTodo.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    saveTodoHandler(e);
  }
});

/*** ====== ATTACH MODAL ====== ***/
const dlgAttach=el('#dlgAttach');
const aSearch=el('#aSearch'), aProject=el('#aProject'), aPerson=el('#aPerson'), aStatus=el('#aStatus'), aSort=el('#aSort'), attachList=el('#attachList');
[aSearch,aProject,aPerson,aStatus,aSort].forEach(c=>c.addEventListener('input',renderAttachList));
let attachCtx=null;
function openAttachModal(ctx){ attachCtx=ctx; const title=ctx.type==='person' ? `Attach tasks ‚Üí ${store.people[ctx.personId]?.name} ¬∑ ${ctx.side==='waitingForMe'?'I‚Äôm waiting on them':'They‚Äôre waiting on me'}` : `Attach tasks ‚Üí Board ‚Äú${store.kanbans[ctx.boardId]?.name}‚Äù, Column ‚Äú${store.kanbans[ctx.boardId]?.columns.find(c=>c.id===ctx.colId)?.name}‚Äù`; el('#attachTitle').textContent=title; refreshProjectSelects(); refreshPeopleSelects(); aSearch.value=''; aProject.value=''; aPerson.value=''; aStatus.value=''; aSort.value='due-asc'; renderAttachList(); dlgAttach.showModal(); }
function renderAttachList(){ let items=Object.values(store.todos); const q=aSearch.value.trim().toLowerCase(); if(q){ items=items.filter(t=>universalHaystack(t).includes(q)); } const proj=aProject.value; if(proj) items=items.filter(t=>t.projectId===proj); const person=aPerson.value; if(person) items=items.filter(t=>(t.people||[]).includes(person)); const st=aStatus.value; if(st) items=items.filter(t=>t.status===st); if(attachCtx?.type==='person'){ const p=store.people[attachCtx.personId]; const arr=(p?.[attachCtx.side]||[]); items=items.filter(t=>!arr.includes(t.id)); } else if(attachCtx?.type==='kanban'){ const kb=store.kanbans[attachCtx.boardId]; const set=new Set(kb?.columns.flatMap(c=>c.todoIds)||[]); items=items.filter(t=>!set.has(t.id)); }
  const sorter=SORTS[aSort.value]||SORTS['due-asc']; items.sort(sorter);
  el('#aCount').textContent=`${items.length} candidates`;
  attachList.innerHTML=items.map(t=>{ const p=store.projects[t.projectId]; return `<div class="todoRow" data-id="${t.id}">
      <input type="checkbox" data-id="${t.id}" />
      <div class="title">${t.title}</div>
      <div class="hiu">
        <span class="d h ${t.eisen?.impact?'on':''}"></span>
        <span class="d i ${t.eisen?.important?'on':''}"></span>
        <span class="d u ${t.eisen?.urgent?'on':''}"></span>
      </div>
      <div class="pill"><span class="dot" style="color:${p?.color||'var(--muted)'}"></span>${p?.name||'‚Äî'}</div>
      <div class="badge">${fmtDue(t.due)}</div>
      <div class="actions"></div>
    </div>`; }).join(''); }
const attachConfirmHandler = e=>{ e.preventDefault(); const ids=els('input[type="checkbox"]:checked',attachList).map(c=>c.dataset.id); if(!ids.length){dlgAttach.close(); return;} if(attachCtx.type==='person'){ const p=store.people[attachCtx.personId]; const arr=(p[attachCtx.side] ||= []); ids.forEach(id=>{ if(!arr.includes(id)) arr.push(id); recomputeTodoPeople(id); }); save(); dlgAttach.close(); renderPeople(); renderTodos(); } else if(attachCtx.type==='kanban'){ ids.forEach(id=>moveInKanban(id, attachCtx.colId)); dlgAttach.close(); } };
el('#btnAttachConfirm').onclick=attachConfirmHandler;
// Add Enter key handler for Attach modal
el('#dlgAttach').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    attachConfirmHandler(e);
  }
});

/*** ====== COMMAND PALETTE ====== ***/
const kbar=el('#kbar'), kinput=el('#kinput'), klist=el('#klist');
const CMDS=[
  {label:'New todo', run:()=>openTodoModal()},
  {label:'Go: Todos', run:()=>setTab('todos')},
  {label:'Go: Projects', run:()=>setTab('projects')},
  {label:'Go: People', run:()=>setTab('people')},
  {label:'Go: Kanban', run:()=>setTab('kanban')},
  {label:'New project', run:()=>el('#dlgProject').showModal()},
  {label:'New person', run:()=>el('#dlgPerson').showModal()},
  {label:'New board', run:()=>el('#btnAddBoard').click()},
  {label:'Edit current board', run:()=>openBoardEditor()},
  {label:'Export backup', run:()=>exportBackup()},
  {label:'Import backup', run:()=>el('#fileImport').click()},
  {label:'Recover from auto-backup', run:()=>recoverAutoBackup()},
  {label:'Clear all filters', run:()=>{ btnClearFilters.click(); }},
  {label:'Focus search', run:()=>{ setTab('todos'); globalSearch.focus(); }},
];
let ksel=0; function openK(){ kbar.classList.add('open'); kbar.setAttribute('aria-hidden','false'); kinput.value=''; renderK(''); kinput.focus(); }
function closeK(){ kbar.classList.remove('open'); kbar.setAttribute('aria-hidden','true'); }
function renderK(q){ const items=CMDS.filter(c=>c.label.toLowerCase().includes(q.toLowerCase())); ksel=0; klist.innerHTML=items.map((c,i)=>`<div class="kitem ${i===0?'sel':''}" data-i="${i}">${c.label}<span class="tiny muted">‚Ü©</span></div>`).join(''); }
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); if(kbar.classList.contains('open')) closeK(); else openK(); }});
kbar.addEventListener('click',(e)=>{ if(e.target===kbar) closeK(); });
kinput.addEventListener('input',()=>renderK(kinput.value));
kinput.addEventListener('keydown',(e)=>{ const items=Array.from(klist.children); if(e.key==='ArrowDown'){ e.preventDefault(); ksel=Math.min(ksel+1, items.length-1); items.forEach((n,i)=>n.classList.toggle('sel',i===ksel)); }
  if(e.key==='ArrowUp'){ e.preventDefault(); ksel=Math.max(0, ksel-1); items.forEach((n,i)=>n.classList.toggle('sel',i===ksel)); }
  if(e.key==='Enter'){ e.preventDefault(); const q=kinput.value.toLowerCase(); const matches=CMDS.filter(c=>c.label.toLowerCase().includes(q)); if(matches[ksel]){ closeK(); matches[ksel].run(); }}
  if(e.key==='Escape'){ closeK(); }
});

/*** ====== CANVAS SYSTEM ====== ***/
let currentCanvasView = 'default';
let draggingEntity = null;
let dragOffset = {x: 0, y: 0};
let canvasTransform = { x: 0, y: 0, scale: 1 };
let isPanning = false;
let panStart = { x: 0, y: 0 };
let clickStart = { x: 0, y: 0, time: 0 };
let hasMoved = false;

function getCurrentCanvasView() {
  if (!store.canvasViews) store.canvasViews = {};
  if (!store.canvasViews[currentCanvasView]) {
    store.canvasViews[currentCanvasView] = {
      id: currentCanvasView,
      name: currentCanvasView === 'default' ? 'Default Canvas' : `Canvas ${currentCanvasView}`,
      entities: {}
    };
  }
  return store.canvasViews[currentCanvasView];
}

function addEntityToCanvas(entityType, entityId) {
  const view = getCurrentCanvasView();
  const key = `${entityType}:${entityId}`;
  
  // Don't add if already exists
  if (view.entities[key]) return;
  
  // Add at random position
  view.entities[key] = {
    x: 100 + Math.random() * 400,
    y: 100 + Math.random() * 300
  };
  
  save();
  renderCanvas();
}

function renderCanvas() {
  const container = el('#canvasContainer');
  const canvas = el('#mainCanvas');
  const viewport = el('#canvasViewport');
  const view = getCurrentCanvasView();
  
  // Clear existing entities
  els('.canvas-entity').forEach(el => el.remove());
  
  // Apply current transform
  updateCanvasTransform();
  
  // Render entities
  Object.entries(view.entities).forEach(([key, pos]) => {
    const [type, id] = key.split(':');
    let entity, title, meta;
    
    if (type === 'todo' && store.todos[id]) {
      entity = store.todos[id];
      title = entity.title;
      meta = `${entity.status} ‚Ä¢ ${store.projects[entity.projectId]?.name || 'No project'}`;
    } else if (type === 'project' && store.projects[id]) {
      entity = store.projects[id];
      title = entity.name;
      meta = `${entity.todoIds?.length || 0} tasks`;
    } else {
      return; // Entity doesn't exist anymore
    }
    
    const entityEl = document.createElement('div');
    entityEl.className = `canvas-entity ${type}`;
    entityEl.style.left = pos.x + 'px';
    entityEl.style.top = pos.y + 'px';
    entityEl.dataset.key = key;
    
    entityEl.innerHTML = `
      <div class="canvas-entity-title">${title}</div>
      <div class="canvas-entity-meta">${meta}</div>
    `;
    
    // Add drag and click functionality
    entityEl.addEventListener('mousedown', startEntityInteraction);
    
    el('#canvasViewport').appendChild(entityEl);
  });
  
  // Update canvas view selector
  updateCanvasViewSelector();
}

// Enhanced interaction system for canvas entities
function startEntityInteraction(e) {
  e.preventDefault();
  e.stopPropagation();
  
  clickStart = {
    x: e.clientX,
    y: e.clientY, 
    time: Date.now()
  };
  hasMoved = false;
  
  draggingEntity = e.currentTarget;
  
  const rect = draggingEntity.getBoundingClientRect();
  const viewportRect = el('#canvasViewport').getBoundingClientRect();
  
  dragOffset = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
  
  document.addEventListener('mousemove', dragEntity);
  document.addEventListener('mouseup', endEntityInteraction);
}

function dragEntity(e) {
  if (!draggingEntity) return;
  
  const moveDistance = Math.abs(e.clientX - clickStart.x) + Math.abs(e.clientY - clickStart.y);
  if (moveDistance > 5) {
    hasMoved = true;
    if (!draggingEntity.classList.contains('dragging')) {
      draggingEntity.classList.add('dragging');
    }
  }
  
  if (hasMoved) {
    const viewportRect = el('#canvasViewport').getBoundingClientRect();
    const x = (e.clientX - viewportRect.left) / canvasTransform.scale - dragOffset.x;
    const y = (e.clientY - viewportRect.top) / canvasTransform.scale - dragOffset.y;
    
    draggingEntity.style.left = x + 'px';
    draggingEntity.style.top = y + 'px';
  }
}

function endEntityInteraction(e) {
  if (!draggingEntity) return;
  
  const key = draggingEntity.dataset.key;
  const view = getCurrentCanvasView();
  
  if (hasMoved) {
    // Save new position
    view.entities[key] = {
      x: parseInt(draggingEntity.style.left),
      y: parseInt(draggingEntity.style.top)
    };
    save();
  } else {
    // Handle click (open modal)
    const clickDuration = Date.now() - clickStart.time;
    if (clickDuration < 300) { // Short click
      openEntityModal(key);
    }
  }
  
  draggingEntity.classList.remove('dragging');
  draggingEntity = null;
  
  document.removeEventListener('mousemove', dragEntity);
  document.removeEventListener('mouseup', endEntityInteraction);
}

function openEntityModal(key) {
  const [type, id] = key.split(':');
  
  if (type === 'todo' && store.todos[id]) {
    // Open todo modal for editing
    const t = store.todos[id];
    const dlgTodo = el('#dlgTodo');
    const tId = el('#tId');
    const tTitle = el('#tTitle');
    const tNotes = el('#tNotes');
    const tProject = el('#tProject');
    const tDue = el('#tDue');
    const tStatus = el('#tStatus');
    
    tId.value = t.id;
    tTitle.value = t.title || '';
    tNotes.value = t.notes || '';
    tProject.value = t.projectId || '';
    tDue.value = t.due || '';
    tStatus.value = t.status || 'todo';
    
    // Set eisen values
    const eisenForm = el('#eisenForm');
    if (eisenForm && t.eisen) {
      els('.d', eisenForm).forEach(d => {
        const key = d.dataset.k;
        d.classList.toggle('on', !!t.eisen[key]);
      });
    }
    
    dlgTodo.showModal();
  } else if (type === 'project') {
    // Switch to projects view and highlight the project
    setTab('projects');
  }
}

function updateCanvasViewSelector() {
  const select = el('#canvasViewSelect');
  const views = Object.values(store.canvasViews || {});
  
  select.innerHTML = views.map(v => 
    `<option value="${v.id}" ${v.id === currentCanvasView ? 'selected' : ''}>${v.name}</option>`
  ).join('');
  
  // Show/hide delete button based on whether it's the default canvas
  const deleteBtn = el('#btnDeleteCanvasView');
  if (deleteBtn) {
    deleteBtn.style.display = currentCanvasView === 'default' ? 'none' : 'grid';
  }
}

function updateCanvasTransform() {
  const viewport = el('#canvasViewport');
  if (viewport) {
    viewport.style.transform = `translate(${canvasTransform.x}px, ${canvasTransform.y}px) scale(${canvasTransform.scale})`;
  }
}

function getCanvasBounds() {
  const view = getCurrentCanvasView();
  const positions = Object.values(view.entities);
  
  if (positions.length === 0) {
    return { minX: 0, minY: 0, maxX: 1200, maxY: 800 };
  }
  
  const minX = Math.min(...positions.map(p => p.x)) - 100;
  const minY = Math.min(...positions.map(p => p.y)) - 100;
  const maxX = Math.max(...positions.map(p => p.x)) + 300;
  const maxY = Math.max(...positions.map(p => p.y)) + 200;
  
  return { minX, minY, maxX, maxY };
}

function fitCanvasToContent() {
  const canvas = el('#mainCanvas');

  const container = el('#canvasContainer');
  const bounds = getCanvasBounds();
  
  const contentWidth = bounds.maxX - bounds.minX;
  const contentHeight = bounds.maxY - bounds.minY;
  
  const scaleX = container.offsetWidth / contentWidth;
  const scaleY = container.offsetHeight / contentHeight;
  
  canvasTransform.scale = Math.min(scaleX, scaleY, 1) * 0.9; // 90% to add padding
  canvasTransform.x = -bounds.minX * canvasTransform.scale + 50;
  canvasTransform.y = -canvas.height -bounds.minY * canvasTransform.scale + 50;
  
  updateCanvasTransform();
}

function showTodoSelector(callback) {
  const todos = Object.values(store.todos);
  const view = getCurrentCanvasView();
  
  // Filter out already added todos
  const availableTodos = todos.filter(t => !view.entities[`todo:${t.id}`]);
  
  if (availableTodos.length === 0) {
    alert('All todos are already on this canvas!');
    return;
  }
  
  const todoId = prompt('Select todo ID:\n' + 
    availableTodos.map(t => `${t.id}: ${t.title}`).join('\n') +
    '\n\nEnter todo ID:');
  
  if (todoId && availableTodos.find(t => t.id === todoId)) {
    callback('todo', todoId);
  }
}

function showProjectSelector(callback) {
  const projects = Object.values(store.projects);
  const view = getCurrentCanvasView();
  
  // Filter out already added projects
  const availableProjects = projects.filter(p => !view.entities[`project:${p.id}`]);
  
  if (availableProjects.length === 0) {
    alert('All projects are already on this canvas!');
    return;
  }
  
  const projectId = prompt('Select project ID:\n' + 
    availableProjects.map(p => `${p.id}: ${p.name}`).join('\n') +
    '\n\nEnter project ID:');
  
  if (projectId && availableProjects.find(p => p.id === projectId)) {
    callback('project', projectId);
  }
}

// Canvas event listeners
el('#btnAddTodoToCanvas')?.addEventListener('click', () => {
  showTodoSelector(addEntityToCanvas);
});

el('#btnAddProjectToCanvas')?.addEventListener('click', () => {
  showProjectSelector(addEntityToCanvas);
});

el('#btnAddAllTodos')?.addEventListener('click', () => {
  const todos = Object.values(store.todos);
  const view = getCurrentCanvasView();
  
  todos.forEach(todo => {
    const key = `todo:${todo.id}`;
    if (!view.entities[key]) {
      addEntityToCanvas('todo', todo.id);
    }
  });
});

el('#canvasViewSelect')?.addEventListener('change', (e) => {
  currentCanvasView = e.target.value;
  canvasTransform = { x: 0, y: 0, scale: 1 }; // Reset transform on view change
  
  // Update delete button visibility
  const deleteBtn = el('#btnDeleteCanvasView');
  if (deleteBtn) {
    deleteBtn.style.display = currentCanvasView === 'default' ? 'none' : 'grid';
  }
  
  renderCanvas();
});

el('#btnAddCanvasView')?.addEventListener('click', () => {
  const name = prompt('Canvas view name:');
  if (!name) return;
  
  const id = 'canvas_' + Date.now();
  store.canvasViews[id] = {
    id,
    name,
    entities: {}
  };
  
  currentCanvasView = id;
  save();
  renderCanvas();
});

// Delete canvas view (except default)
el('#btnDeleteCanvasView')?.addEventListener('click', () => {
  if (currentCanvasView === 'default') {
    alert('Cannot delete the default canvas');
    return;
  }
  
  const view = store.canvasViews[currentCanvasView];
  if (!view) return;
  
  if (!confirm(`Delete canvas "${view.name}"?`)) return;
  
  delete store.canvasViews[currentCanvasView];
  currentCanvasView = 'default';
  save();
  renderCanvas();
});

// Create canvas from visible todos in todos view
el('#btnCreateCanvasFromTodos')?.addEventListener('click', () => {
  const name = prompt('Canvas name:', 'Filtered Todos');
  if (!name) return;
  
  // Get currently visible todos from viewData
  const visibleTodos = [...viewData.todos];
  
  if (visibleTodos.length === 0) {
    alert('No todos to add to canvas. Adjust your filters to show todos.');
    return;
  }
  
  const id = 'canvas_' + Date.now();
  const entities = {};
  
  // Arrange todos in a grid
  const cols = Math.ceil(Math.sqrt(visibleTodos.length));
  visibleTodos.forEach((todo, i) => {
    const col = i % cols;
    const row = Math.floor(i / cols);
    entities[`todo:${todo.id}`] = {
      x: col * 300 + 50,
      y: row * 200 + 50
    };
  });
  
  store.canvasViews[id] = {
    id,
    name,
    entities
  };
  
  // Switch to canvas view and select the new canvas
  currentCanvasView = id;
  setTab('canvas');
  save();
});

// Toggle canvas fullscreen (both custom and browser fullscreen)
el('#btnCanvasFullscreen')?.addEventListener('click', async () => {
  const body = document.body;
  const isFullscreen = body.classList.contains('canvas-fullscreen');
  
  if (isFullscreen) {
    // Exit both custom and browser fullscreen
    body.classList.remove('canvas-fullscreen');
    el('#btnCanvasFullscreen').title = 'Toggle fullscreen';
    
    // Exit browser fullscreen
    if (document.fullscreenElement) {
      await document.exitFullscreen();
    }
  } else {
    // Enter both custom and browser fullscreen
    body.classList.add('canvas-fullscreen');
    el('#btnCanvasFullscreen').title = 'Exit fullscreen';
    
    // Enter browser fullscreen
    try {
      await document.documentElement.requestFullscreen();
    } catch (err) {
      console.warn('Could not enter browser fullscreen:', err);
    }
  }
  
  // Re-render canvas to adjust to new dimensions
  setTimeout(() => {
    renderCanvas();
  }, 100);
});

// Listen for browser fullscreen changes (e.g., user presses ESC or F11)
document.addEventListener('fullscreenchange', () => {
  const body = document.body;
  
  // If browser exited fullscreen, also exit our custom fullscreen
  if (!document.fullscreenElement && body.classList.contains('canvas-fullscreen')) {
    body.classList.remove('canvas-fullscreen');
    el('#btnCanvasFullscreen').title = 'Toggle fullscreen';
    setTimeout(() => {
      renderCanvas();
    }, 100);
  }
});

// Reset canvas view to top left
el('#btnCanvasReset')?.addEventListener('click', () => {
  const canvas = el('#mainCanvas');
  
  canvasTransform.scale = 1;

  // Find top-left-most entity
  const view = getCurrentCanvasView();
  const positions = Object.values(view.entities);
  if (positions.length === 0) {
    canvasTransform.x = 0;
    canvasTransform.y = -canvas.height;;
    canvasTransform.scale = 1;
  } else {
    const minX = Math.min(...positions.map(p => p.x));
    const minY = Math.min(...positions.map(p => p.y));
    canvasTransform.x = -minX + 50;
    canvasTransform.y = -canvas.height - minY;
    canvasTransform.scale = 1;
  }
  updateCanvasTransform();
  renderCanvas();
});

// Zoom and pan event listeners
const canvasContainer = el('#canvasContainer');

// Trackpad detection: trackpads typically have smaller, more frequent deltaY values
// We'll detect this by checking if deltas are small and precise (< 50 and not multiples of 100)
let isTrackpad = null;
let wheelSamples = [];

// Mouse wheel zoom OR trackpad pan (smart detection)
canvasContainer?.addEventListener('wheel', (e) => {
  e.preventDefault();
  
  // Detect trackpad vs mouse wheel based on delta characteristics
  if (isTrackpad === null && wheelSamples.length < 5) {
    // Collect samples to determine input device
    wheelSamples.push(Math.abs(e.deltaY));
    
    if (wheelSamples.length === 5) {
      // Trackpads: small, variable deltas (usually < 50)
      // Mouse wheels: large, discrete deltas (usually 100, 120, or multiples)
      const avgDelta = wheelSamples.reduce((a, b) => a + b, 0) / wheelSamples.length;
      const hasSmallDeltas = wheelSamples.every(d => d < 50);
      const hasVariableDeltas = new Set(wheelSamples).size > 2;
      
      isTrackpad = hasSmallDeltas && hasVariableDeltas;
      console.log('Input device detected:', isTrackpad ? 'Trackpad' : 'Mouse wheel', 
                  '(avg delta:', avgDelta.toFixed(1), ')');
    }
  }
  
  if (isTrackpad) {
    // TRACKPAD: Check if user wants to zoom (Cmd/Ctrl held) or pan
    if (e.ctrlKey || e.metaKey) {
      // Cmd/Ctrl + trackpad scroll = ZOOM (pinch gesture)
      const rect = canvasContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      const zoomFactor = e.deltaY > 0 ? 0.98 : 1.02;
      const newScale = Math.max(0.1, Math.min(3, canvasTransform.scale * zoomFactor));
      
      // Zoom towards mouse position
      const scaleRatio = newScale / canvasTransform.scale;
      canvasTransform.x = mouseX - (mouseX - canvasTransform.x) * scaleRatio;
      canvasTransform.y = mouseY - (mouseY - canvasTransform.y) * scaleRatio;
      canvasTransform.scale = newScale;
      
      updateCanvasTransform();
    } else {
      // Regular trackpad scroll = PAN (two-finger pan)
      const panSpeed = 1.5; // Adjust sensitivity
      canvasTransform.x -= e.deltaX * panSpeed;
      canvasTransform.y -= e.deltaY * panSpeed;
      updateCanvasTransform();
    }
  } else if (isTrackpad === false) {
    // MOUSE WHEEL: Zoom behavior
    const rect = canvasContainer.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    const zoomFactor = e.deltaY > 0 ? 0.98 : 1.02;
    const newScale = Math.max(0.1, Math.min(3, canvasTransform.scale * zoomFactor));
    
    // Zoom towards mouse position
    const scaleRatio = newScale / canvasTransform.scale;
    canvasTransform.x = mouseX - (mouseX - canvasTransform.x) * scaleRatio;
    canvasTransform.y = mouseY - (mouseY - canvasTransform.y) * scaleRatio;
    canvasTransform.scale = newScale;
    
    updateCanvasTransform();
  }
});

// Pan with mouse drag on canvas background
canvasContainer?.addEventListener('mousedown', (e) => {
  if (e.target === canvasContainer || e.target.id === 'mainCanvas') {
    isPanning = true;
    panStart = { x: e.clientX - canvasTransform.x, y: e.clientY - canvasTransform.y };
    canvasContainer.style.cursor = 'grabbing';
    e.preventDefault();
  }
});

document.addEventListener('mousemove', (e) => {
  if (isPanning) {
    canvasTransform.x = e.clientX - panStart.x;
    canvasTransform.y = e.clientY - panStart.y;
    updateCanvasTransform();
  }
});

document.addEventListener('mouseup', () => {
  if (isPanning) {
    isPanning = false;
    if (canvasContainer) canvasContainer.style.cursor = 'grab';
  }
});

// Touch support for mobile zoom/pan
canvasContainer?.addEventListener('touchstart', (e) => {
  e.preventDefault();
  // Handle touch pan/zoom - basic implementation
});

canvasContainer?.addEventListener('touchmove', (e) => {
  e.preventDefault();
  // Handle touch gestures
});

canvasContainer?.addEventListener('touchend', (e) => {
  e.preventDefault();
});

// Arrangement functionality
el('#btnArrangeEntities')?.addEventListener('click', () => {
  showArrangementDialog();
});

el('#btnFitToContent')?.addEventListener('click', () => {
  fitCanvasToContent();
});

function showArrangementDialog() {
  const view = getCurrentCanvasView();
  const entityCount = Object.keys(view.entities).length;
  
  if (entityCount === 0) {
    alert('No entities to arrange on this canvas!');
    return;
  }
  
  const arrangeBy = prompt(`‚ö†Ô∏è WARNING: This will overwrite all custom positions!\n\nCurrent entities: ${entityCount}\n\nArrange by:\n1. project\n2. status\n3. priority\n4. grid\n\nEnter option (1-4) or cancel:`);
  
  if (!arrangeBy) return;
  
  const confirmationText = `ARRANGE ${entityCount} ENTITIES`;
  const userConfirmation = prompt(`üö® FINAL CONFIRMATION üö®\n\nThis will PERMANENTLY OVERWRITE all ${entityCount} custom positions you've carefully placed.\n\nType exactly: "${confirmationText}" to confirm:`);
  
  if (userConfirmation !== confirmationText) {
    alert('Arrangement canceled - positions preserved.');
    return;
  }
  
  switch(arrangeBy) {
    case '1': arrangeByProject(); break;
    case '2': arrangeByStatus(); break;
    case '3': arrangeByPriority(); break;
    case '4': arrangeInGrid(); break;
    default: alert('Invalid option - arrangement canceled.');
  }
}

function arrangeByProject() {
  const view = getCurrentCanvasView();
  const groups = {};
  
  // Group entities
  Object.entries(view.entities).forEach(([key, pos]) => {
    const [type, id] = key.split(':');
    let projectId = 'no-project';
    
    if (type === 'todo' && store.todos[id]) {
      projectId = store.todos[id].projectId || 'no-project';
    } else if (type === 'project') {
      projectId = id;
    }
    
    if (!groups[projectId]) groups[projectId] = [];
    groups[projectId].push(key);
  });
  
  // Position groups
  let groupX = 50;
  Object.entries(groups).forEach(([projectId, keys]) => {
    let entityY = 50;
    
    keys.forEach(key => {
      view.entities[key] = { x: groupX, y: entityY };
      entityY += 120;
    });
    
    groupX += 300;
  });
  
  save();
  renderCanvas();
  alert('Arranged by project! üìÅ');
}

function arrangeByStatus() {
  const view = getCurrentCanvasView();
  const statusOrder = ['todo', 'in-progress', 'waiting', 'review', 'done'];
  const groups = {};
  
  // Group by status
  Object.entries(view.entities).forEach(([key, pos]) => {
    const [type, id] = key.split(':');
    let status = 'unknown';
    
    if (type === 'todo' && store.todos[id]) {
      status = store.todos[id].status || 'todo';
    } else if (type === 'project') {
      status = 'project';
    }
    
    if (!groups[status]) groups[status] = [];
    groups[status].push(key);
  });
  
  // Position by status columns
  let columnX = 50;
  statusOrder.concat(['project', 'unknown']).forEach(status => {
    if (groups[status]) {
      let entityY = 50;
      groups[status].forEach(key => {
        view.entities[key] = { x: columnX, y: entityY };
        entityY += 100;
      });
      columnX += 250;
    }
  });
  
  save();
  renderCanvas();
  alert('Arranged by status! üìä');
}

function arrangeByPriority() {
  const view = getCurrentCanvasView();
  const entities = Object.entries(view.entities);
  
  // Sort by priority (HIU score)
  entities.sort(([keyA], [keyB]) => {
    const [typeA, idA] = keyA.split(':');
    const [typeB, idB] = keyB.split(':');
    
    const getScore = (type, id) => {
      if (type === 'todo' && store.todos[id]) {
        const e = store.todos[id].eisen || {};
        return (e.impact || 0) + (e.important || 0) + (e.urgent || 0);
      }
      return type === 'project' ? 5 : 0; // Projects at top
    };
    
    return getScore(typeB, idB) - getScore(typeA, idA);
  });
  
  // Arrange in priority order (top to bottom, left to right)
  let x = 50, y = 50;
  const maxWidth = 900;
  
  entities.forEach(([key], index) => {
    view.entities[key] = { x, y };
    
    x += 200;
    if (x > maxWidth) {
      x = 50;
      y += 120;
    }
  });
  
  save();
  renderCanvas();
  alert('Arranged by priority! ‚≠ê');
}

function arrangeInGrid() {
  const view = getCurrentCanvasView();
  const entities = Object.keys(view.entities);
  const cols = Math.ceil(Math.sqrt(entities.length));
  
  let row = 0, col = 0;
  entities.forEach(key => {
    view.entities[key] = {
      x: 80 + col * 180,
      y: 80 + row * 140
    };
    
    col++;
    if (col >= cols) {
      col = 0;
      row++;
    }
  });
  
  save();
  renderCanvas();
  alert('Arranged in grid! üìã');
}

/*** ====== INIT & RENDER ====== ***/
function render(full = false) {
  const currentTab = store.current.tab;
  els('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === currentTab));
  views.forEach(id => el('#view-' + id).classList.toggle('hidden', currentTab !== id));

  if (full) {
    restoreViewState();
    restoreGlobalFilters();
  }
  
  // ALWAYS compute view data first - this is the single source of truth
  updateGlobalFilters(); // Update filter dropdowns
  computeViewData();     // Compute filtered data for all views

  switch (currentTab) {
    case 'todos':
      renderMainTodos();
      break;
    case 'projects':
      renderProjects();
      break;
    case 'people':
      renderPeople();
      break;
    case 'kanban':
      renderKanban();
      break;
    case 'canvas':
      renderCanvas();
      break;
  }
}

// Detect changes from other tabs or windows
window.addEventListener('storage', (e) => {
  if (e.key === LS_KEY && e.newValue) {
    try {
      const newData = JSON.parse(e.newValue);
      const oldSaveCount = store._saveCount || 0;
      const newSaveCount = newData._saveCount || 0;
      
      console.warn('‚ö†Ô∏è Data changed in another tab!');
      console.log('Old save count:', oldSaveCount, 'New save count:', newSaveCount);
      console.log('Old last saved:', store._lastSaved || 'unknown');
      console.log('New last saved:', newData._lastSaved || 'unknown');
      
      if (confirm('‚ö†Ô∏è Data was changed in another tab/window.\n\nYour version: Save #' + oldSaveCount + ' at ' + (store._lastSaved || 'unknown') + '\nOther version: Save #' + newSaveCount + ' at ' + (newData._lastSaved || 'unknown') + '\n\nReload to see the latest changes?\n\n(Click Cancel to keep working with your current version)')) {
        store = newData;
        render(true);
        alert('‚úÖ Reloaded with latest data from other tab');
      } else {
        alert('‚ö†Ô∏è You kept your version. Be careful - saving now will overwrite the other tab\'s changes!');
      }
    } catch (err) {
      console.error('Error handling storage event:', err);
    }
  }
});

render(true);
</script>

</body>
</html>
