<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Job Work Dashboard Manager ‚Äî vNext (single file)</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --fg:#0b0d12; --muted:#667084;
    --acc:#2563eb; --ok:#16a34a; --warn:#b45309; --bad:#dc2626; --border:#e6e8ef;
    --impact:#1d4ed8; --important:#15803d; --urgent:#b91c1c;
    --shadow:0 10px 26px rgba(0,0,0,.07);
    --radius:16px; --gap:12px; --pad:14px; --tap:38px; --maxw:1100px;
    color-scheme:light dark;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0d12; --panel:#12151c; --card:#171a23; --fg:#e9edf5; --muted:#9aa0aa; --border:#232838; --shadow:0 12px 36px rgba(0,0,0,.35); }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  a{color:var(--acc);text-decoration:none}
  button{cursor:pointer}
  .link{cursor:text;}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(8px,2vw,14px)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.2) blur(6px);
    background:color-mix(in oklab,var(--bg) 82%,transparent);border-bottom:1px solid var(--border)}
  .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;display:grid;place-items:center;border-radius:10px;
    background:radial-gradient(80% 80% at 20% 20%,var(--acc),transparent),var(--panel);
    box-shadow:var(--shadow);font-weight:800}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;background:var(--panel);border:1px solid var(--border);padding:6px;border-radius:999px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid transparent;background:transparent;font-weight:600;color:var(--muted)}
  .tab.active{background:color-mix(in oklab,var(--acc) 12%,transparent);color:var(--fg);border-color:color-mix(in oklab,var(--acc) 30%,transparent)}
  .rightbar{display:flex;align-items:center;gap:8px}
  .iconbtn{min-width:var(--tap);height:var(--tap);border-radius:12px;border:1px solid var(--border);background:var(--panel);
    display:grid;place-items:center;box-shadow:var(--shadow);font-size:18px;color:var(--fg)}
  .hidden{display:none!important}

  .panel{margin-top:12px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad)}

  .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  @media (max-width:800px){.filters{grid-template-columns:1fr 1fr}}
  select,input[type="text"],input[type="date"],textarea{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--fg)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--card);border:1px solid var(--border);font-size:12px}
  .pill .dot{width:8px;height:8px;border-radius:999px;background:currentColor}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel)}
  .status-todo{background:transparent}.status-in-progress{background:color-mix(in oklab,var(--acc) 10%,transparent)}
  .status-review{background:color-mix(in oklab,var(--warn) 16%,transparent)}.status-done{background:color-mix(in oklab,var(--ok) 16%,transparent)}
  .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .action{background:var(--acc)!important;color:#fff!important;border-color:transparent!important}

  /* Ultra-compact Todos rows, with visible due field */
  .list-todos{display:grid;gap:6px;margin-top:10px}
  .todoRow{
    border:1px solid var(--border);background:var(--card);border-radius:10px;padding:4px 6px;
    display:grid;gap:6px;align-items:center;
    grid-template-columns: 98px 1fr 64px minmax(120px,180px) minmax(132px,160px);
    cursor:pointer;transition:background-color 0.15s ease;
  }
  .todoRow:hover{background:color-mix(in oklab,var(--card) 90%,var(--acc))}
  .todoHeader{
    border:1px solid var(--border);background:var(--panel);border-radius:10px;padding:6px 6px;
    display:grid;gap:6px;align-items:center;
    grid-template-columns: 98px 1fr 64px minmax(120px,180px) minmax(132px,160px);
    font-weight:600;font-size:12px;color:var(--muted);
  }
  .todoRow .statusSel{width:100%;font-size:12px;border-radius:8px;padding:4px}
  .todoRow .projectSel{width:100%;font-size:12px;border-radius:8px;padding:4px}
  .todoRow .title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600}
  .todoRow .title[contenteditable="true"]{outline:2px dashed transparent;border-radius:6px;padding:2px 4px}
  .todoRow .title:focus{outline:2px dashed var(--acc);background:color-mix(in oklab,var(--acc) 8%, transparent)}
  .project-name[contenteditable="true"]{outline:2px dashed transparent;border-radius:6px;padding:2px 4px;display:inline-block}
  .project-name:focus{outline:2px dashed var(--acc);background:color-mix(in oklab,var(--acc) 8%, transparent)}
  .todoRow .actions{display:flex;gap:6px;justify-content:flex-end}
  
  @media (max-width:900px){ 
    .todoRow{grid-template-columns:1fr} 
    .todoRow .actions{justify-content:flex-start}
    .todoHeader{display:none} 
  }

  /* HIU strip */
  .hiu{display:inline-grid;grid-auto-flow:column;gap:4px;align-items:center}
  .hiu .d{width:14px;height:14px;border-radius:3px;border:1px solid var(--border);background:var(--panel);display:block}
  .hiu .d.h.on{background:var(--impact);border-color:transparent}
  .hiu .d.i.on{background:var(--important);border-color:transparent}
  .hiu .d.u.on{background:var(--urgent);border-color:transparent}

  .list{display:grid;gap:10px;margin-top:12px}
  .card{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:12px;display:grid;gap:6px}
  .card[data-pid]{cursor:pointer;transition:background-color 0.15s ease}
  .card[data-pid]:hover{background:color-mix(in oklab,var(--card) 90%,var(--acc))}
  .card[kb]{transition:background-color 0.15s ease, transform 0.15s ease}
  .card[kb]:hover{background:color-mix(in oklab,var(--card) 90%,var(--acc));transform:translateY(-1px)}
  .cardhead{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .cardtitle{font-weight:700}
  .inline-list{font-size:12px;color:var(--muted)}
  .inline-list .item{display:inline}.inline-list .sep{opacity:.5;margin:0 6px}

  .grid-boards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:900px){.grid-boards{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){.grid-boards{grid-template-columns:1fr}}
  .column{background:var(--panel);border:1px dashed var(--border);border-radius:14px;padding:10px;min-height:140px}
  .colhead{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:6px;font-weight:700}
  .coltools{display:flex;gap:6px;align-items:center}
  .dropzone{min-height:80px}.dropzone.over{outline:2px solid var(--acc);outline-offset:2px;border-radius:12px}

  .fab{position:fixed;right:16px;bottom:16px;z-index:20;width:56px;height:56px;border-radius:18px;background:var(--acc);color:#fff;border:none;box-shadow:var(--shadow);font-size:28px;display:grid;place-items:center}

  dialog{border:none;padding:0;border-radius:18px;width:min(820px,92vw);background:var(--panel);color:var(--fg)}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .modal{padding:16px} .modal h3{margin:0 0 8px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  .tiny{font-size:12px}
  .xbtn{border:none;background:transparent;font-size:14px;color:var(--muted);cursor:pointer}

  /* Command palette */
  .kbar{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .kbar.open{display:flex}
  .kpanel{margin-top:10vh;width:min(720px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .khead{padding:10px;border-bottom:1px solid var(--border)}
  .khead input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--fg)}
  .klist{max-height:50vh;overflow:auto}
  .kitem{padding:10px 12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .kitem.sel{background:color-mix(in oklab,var(--acc) 12%, transparent)}

</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo">JW</div>
      <div>
        <div style="font-weight:800">Job Work Dashboard</div>
        <div class="tiny muted">Single-file MVP ¬∑ localStorage ¬∑ Light/Dark</div>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="todos">Todos</button>
      <button class="tab" data-tab="projects">Projects</button>
      <button class="tab" data-tab="people">People</button>
      <button class="tab" data-tab="kanban">Kanban</button>
    </div>
    <div class="rightbar">
      <button class="iconbtn" id="btnExport" title="Export backup (download JSON)">‚¨áÔ∏è</button>
      <button class="iconbtn" id="btnImport" title="Import backup (upload JSON)">‚¨ÜÔ∏è</button>
      <input type="file" id="fileImport" accept="application/json" class="hidden">
    </div>
  </div>
</header>

<main class="wrap">
  <!-- TODOS -->
  <section id="view-todos" class="panel">
    <div class="filters">
      <div><label>Search</label><input type="text" id="fSearch" placeholder="Search anything‚Ä¶"></div>
      <div><label>Project</label><select id="fProject"><option value="">All projects</option></select></div>
      <div><label>Person</label><select id="fPerson"><option value="">All people</option></select></div>
      <div><label>Sort</label>
        <select id="fSort">
          <option value="due-asc">Due ‚Üë</option>
          <option value="due-desc">Due ‚Üì</option>
          <option value="priority-desc">Priority (HIU) ‚Üì</option>
          <option value="priority-asc">Priority (HIU) ‚Üë</option>
          <option value="status-asc">Status A‚ÜíZ</option>
          <option value="project-asc">Project A‚ÜíZ</option>
          <option value="project-desc">Project Z‚ÜíA</option>
          <option value="title-asc">Title A‚ÜíZ</option>
          <option value="created-desc">Created ‚Üì</option>
        </select>
      </div>
    </div>
    <div class="toolbar"><span class="note" id="countInfo"></span></div>
    <div class="list-todos" id="todoList"></div>
  </section>

  <!-- PROJECTS -->
  <section id="view-projects" class="panel hidden">
    <div class="toolbar"><button class="iconbtn action" id="btnAddProject" title="Add project">Ôºã</button>
      <span class="note">Inline, ultra-compact todos per project.</span></div>
    <div class="list" id="projectList"></div>
  </section>

  <!-- PEOPLE -->
  <section id="view-people" class="panel hidden">
    <div class="toolbar"><button class="iconbtn action" id="btnAddPerson" title="Add person">Ôºã</button>
      <span class="note">Attach existing tasks; tap √ó to remove.</span></div>
    <div class="list" id="peopleList"></div>
  </section>

  <!-- KANBAN -->
  <section id="view-kanban" class="panel hidden">
    <div class="toolbar" style="gap:6px;align-items:end">
      <div><label class="tiny muted">Board</label><select id="kbSelect"></select></div>
      <button class="iconbtn" id="btnEditBoard" title="Edit board">‚öôÔ∏è</button>
      <div><label class="tiny muted">Filter by project</label><select id="kbProject"><option value="">All</option></select></div>
      <button class="iconbtn action" id="btnAddBoard" title="New board">Ôºã</button>
    </div>
    <div class="grid-boards" id="kanbanGrid"></div>
  </section>
</main>

<button class="fab" id="fabAdd" title="Add todo">Ôºã</button>

<!-- MODAL: ADD/EDIT TODO -->
<dialog id="dlgTodo">
  <form method="dialog" class="modal" id="todoForm">
    <h3 id="todoFormTitle">New Todo</h3>
    <div class="row">
      <div><label>Title</label><input type="text" id="tTitle" required></div>
      <div><label>Project</label><select id="tProject"></select></div>
    </div>
    <div class="row">
      <div><label>Due date</label><input type="date" id="tDue"></div>
      <div><label>Status</label><select id="tStatus">
        <option value="todo">Todo</option><option value="in-progress">In Progress</option>
        <option value="review">Review</option><option value="done">Done</option></select></div>
    </div>
    <div>
      <label>Eisenhower (H/I/U)</label>
      <div class="hiu" id="eisenForm">
        <span class="d h" data-k="impact" title="High impact"></span>
        <span class="d i" data-k="important" title="Important"></span>
        <span class="d u" data-k="urgent" title="Urgent"></span>
      </div>
    </div>
    <div><label>Tags (comma separated)</label><input type="text" id="tTags" placeholder="design, api, review"></div>
    <div><label>Notes</label><textarea id="tNotes" rows="3" placeholder="Optional details‚Ä¶"></textarea></div>
    <div class="row">
      <div><label>I‚Äôm waiting on‚Ä¶ (multi-select)</label><select id="selWaitingOn" multiple size="6"></select>
        <div class="tiny muted" style="margin-top:4px">üí° Ctrl+click to deselect items ¬∑ <button type="button" id="btnClearWaitingOn" style="background:none;border:none;color:var(--acc);cursor:pointer;font-size:11px">Clear all</button></div></div>
      <div><label>They‚Äôre waiting on me‚Ä¶ (multi-select)</label><select id="selWaitingOnMe" multiple size="6"></select>
        <div class="tiny muted" style="margin-top:4px">üí° Ctrl+click to deselect items ¬∑ <button type="button" id="btnClearWaitingOnMe" style="background:none;border:none;color:var(--acc);cursor:pointer;font-size:11px">Clear all</button></div></div>
    </div>
    <div class="toolbar" style="justify-content:space-between">
      <button id="btnDeleteTodo" type="button" class="pill" style="background:var(--bad);color:#fff;border-color:transparent;display:none">üóë Delete</button>
      <div style="display:flex;gap:8px">
        <button value="cancel" class="pill">Cancel</button>
        <button id="btnSaveTodo" value="default" class="pill action">Save</button>
      </div>
    </div>
    <input type="hidden" id="tId">
  </form>
</dialog>

<!-- MODAL: ADD PROJECT -->
<dialog id="dlgProject">
  <form method="dialog" class="modal" id="projectForm">
    <h3>New Project</h3>
    <div class="row">
      <div><label>Name</label><input type="text" id="pName" required></div>
      <div><label>Color</label><input type="color" id="pColor" value="#7cc9ff"></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnSaveProject" value="default" class="pill action">Save</button>
    </div>
  </form>
</dialog>

<!-- MODAL: ADD PERSON -->
<dialog id="dlgPerson">
  <form method="dialog" class="modal" id="personForm">
    <h3>New Person</h3>
    <div class="row">
      <div><label>Name</label><input type="text" id="sName" required></div>
      <div><label>Initials</label><input type="text" id="sInit" placeholder="AB" maxlength="3"></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnSavePerson" value="default" class="pill action">Save</button>
    </div>
  </form>
</dialog>

<!-- MODAL: ATTACH EXISTING TASKS -->
<dialog id="dlgAttach">
  <form method="dialog" class="modal" id="attachForm">
    <h3 id="attachTitle">Attach tasks</h3>
    <div class="filters">
      <div><label>Search</label><input type="text" id="aSearch" placeholder="Search anything‚Ä¶"></div>
      <div><label>Project</label><select id="aProject"><option value="">All projects</option></select></div>
      <div><label>Person</label><select id="aPerson"><option value="">All people</option></select></div>
      <div><label>Status</label><select id="aStatus"><option value="">Any</option><option value="todo">Todo</option><option value="in-progress">In Progress</option><option value="review">Review</option><option value="done">Done</option></select></div>
    </div>
    <div class="toolbar">
      <div><label class="tiny muted">Sort by</label>
        <select id="aSort">
          <option value="due-asc">Due ‚Üë</option><option value="due-desc">Due ‚Üì</option>
          <option value="priority-desc">Priority ‚Üì</option><option value="priority-asc">Priority ‚Üë</option>
          <option value="created-desc">Created ‚Üì</option><option value="title-asc">Title A‚ÜíZ</option>
        </select>
      </div>
      <span class="note" id="aCount"></span>
    </div>
    <div class="list-todos" id="attachList"></div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnAttachConfirm" value="default" class="pill action">Attach</button>
    </div>
  </form>
</dialog>

<!-- MODAL: EDIT BOARD (rename + custom columns) -->
<dialog id="dlgBoard">
  <form method="dialog" class="modal" id="boardForm">
    <h3>Edit Board</h3>
    <div><label>Name</label><input type="text" id="bName"></div>
    <div style="margin-top:8px">
      <label>Columns</label>
      <div id="bCols"></div>
      <div class="toolbar"><button class="pill action" id="btnAddCol" type="button">Add column</button></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnSaveBoard" value="default" class="pill action">Save</button>
    </div>
  </form>
</dialog>

<!-- MODAL: DELETE PROJECT -->
<dialog id="dlgDeleteProject">
  <form method="dialog" class="modal" id="deleteProjectForm">
    <h3>Delete Project</h3>
    <div style="margin-bottom:16px">
      <div style="padding:12px;background:color-mix(in oklab,var(--warn) 10%,transparent);border:1px solid color-mix(in oklab,var(--warn) 30%,transparent);border-radius:12px;margin-bottom:12px">
        <strong>‚ö†Ô∏è Warning:</strong> You are about to delete "<span id="deleteProjectName"></span>".
      </div>
      <p style="margin:8px 0">What should happen to the <strong><span id="deleteTodoCount"></span></strong> assigned to this project?</p>
      
      <div style="margin:12px 0">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="radio" name="deleteMode" value="unassign" checked>
          <span><strong>Unassign todos</strong> (recommended)<br><small class="muted">Todos will remain but be unassigned from this project</small></span>
        </label>
      </div>
      
      <div style="margin:12px 0">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="radio" name="deleteMode" value="reassign" id="reassignRadio">
          <span><strong>Reassign to another project</strong><br><small class="muted">Move all todos to a different project</small></span>
        </label>
        <div style="margin-top:8px;margin-left:32px" id="reassignProjectContainer">
          <select id="reassignProjectSelect" style="width:100%" disabled>
            <option value="">Select target project...</option>
          </select>
        </div>
      </div>
      
      <!-- Collapsible dangerous option -->
      <details style="margin-top:16px">
        <summary style="cursor:pointer;color:var(--bad);font-size:12px;padding:4px 0">‚ö†Ô∏è Show destructive option</summary>
        <div style="margin-top:8px;padding:12px;background:color-mix(in oklab,var(--bad) 8%,transparent);border:1px solid color-mix(in oklab,var(--bad) 30%,transparent);border-radius:8px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="deleteMode" value="deleteTodos">
            <span style="color:var(--bad)"><strong>Delete all todos in this project</strong><br><small>‚ö†Ô∏è This action cannot be undone!</small></span>
          </label>
        </div>
      </details>
    </div>
    
    <div class="toolbar" style="justify-content:space-between">
      <button value="cancel" class="pill">Cancel</button>
      <button id="btnConfirmDeleteProject" value="default" class="pill" style="background:var(--bad);color:#fff;border-color:transparent">Delete Project</button>
    </div>
    <input type="hidden" id="deleteProjectId">
  </form>
</dialog>

<!-- COMMAND PALETTE -->
<div class="kbar" id="kbar" aria-hidden="true">
  <div class="kpanel">
    <div class="khead"><input id="kinput" placeholder="Type a command‚Ä¶ (e.g. new, go kanban, filter status:todo)"/></div>
    <div class="klist" id="klist"></div>
  </div>
</div>

<script>
/*** ====== DATA ====== ***/
const LS_KEY='jwdm_v1';
const demoData=()=>({
  meta:{version:3,lastId:100},
  current:{tab:'todos',sort:'due-asc',activeKanbanId:'default'},
  todos:{
    1:{id:'1',title:'Finalize wireframes',notes:'Homepage + pricing',projectId:'p1',people:[],tags:['design'],due:dateStrOffset(2),created:Date.now()-86400000*2,status:'in-progress',eisen:{impact:1,important:1,urgent:0}},
    2:{id:'2',title:'API auth flow',notes:'Add refresh tokens',projectId:'p1',people:['a'],tags:['api','security'],due:dateStrOffset(5),created:Date.now()-86400000*3,status:'todo',eisen:{impact:1,important:0,urgent:1}},
    3:{id:'3',title:'Client feedback pass',notes:'Summarize and triage',projectId:'p2',people:['b'],tags:['pm'],due:dateStrOffset(1),created:Date.now()-86400000,status:'review',eisen:{impact:1,important:1,urgent:1}},
    4:{id:'4',title:'Billing bugfix',notes:'Rounding issue',projectId:'p1',people:['c'],tags:['bug'],due:dateStrOffset(0),created:Date.now()-3600*1000,status:'in-progress',eisen:{impact:1,important:0,urgent:1}},
    5:{id:'5',title:'Write release notes',notes:'',projectId:'p2',people:[],tags:['docs'],due:'',created:Date.now(),status:'todo',eisen:{impact:1,important:0,urgent:0}}
  },
  projects:{ p1:{id:'p1',name:'LaunchPad',color:'#7cc9ff',todoIds:['1','2','4']}, p2:{id:'p2',name:'Client Alpha',color:'#ffd36b',todoIds:['3','5']} },
  people:{
    a:{id:'a',name:'Alex',initials:'AX',waitingForMe:['2'],waitingForThem:['3']},
    b:{id:'b',name:'Bea',initials:'BE',waitingForMe:['3'],waitingForThem:[]},
    c:{id:'c',name:'Chris',initials:'CH',waitingForMe:['4'],waitingForThem:[]}
  },
  kanbans:{
    kb1:{id:'kb1',name:'Default',columns:[
      {id:'col-backlog',name:'Backlog',todoIds:['5']},
      {id:'col-progress',name:'In Progress',todoIds:['1','4']},
      {id:'col-review',name:'Review',todoIds:['3']},
      {id:'col-done',name:'Done',todoIds:[]}
    ]}
  }
});
function dateStrOffset(days){const d=new Date(Date.now()+days*86400000);return d.toISOString().slice(0,10);} 
let store=load();
function load(){try{const raw=localStorage.getItem(LS_KEY);if(!raw){const d=demoData();localStorage.setItem(LS_KEY,JSON.stringify(d));return structuredClone(d);}return JSON.parse(raw);}catch(e){console.error(e);const d=demoData();localStorage.setItem(LS_KEY,JSON.stringify(d));return structuredClone(d);}}
function save(){localStorage.setItem(LS_KEY,JSON.stringify(store));}
function nextId(){store.meta.lastId++;return String(store.meta.lastId);} 

function deleteTodo(id) {
  if (!id || !store.todos[id]) return false;
  
  // Remove from todos
  delete store.todos[id];
  
  // Remove from projects
  Object.values(store.projects).forEach(p => {
    if (p.todoIds?.includes(id)) {
      p.todoIds = p.todoIds.filter(tid => tid !== id);
    }
  });
  
  // Remove from people waiting lists
  Object.values(store.people).forEach(p => {
    if (p.waitingForMe?.includes(id)) {
      p.waitingForMe = p.waitingForMe.filter(tid => tid !== id);
    }
    if (p.waitingForThem?.includes(id)) {
      p.waitingForThem = p.waitingForThem.filter(tid => tid !== id);
    }
  });
  
  // Remove from kanban columns
  Object.values(store.kanbans).forEach(kb => {
    kb.columns.forEach(col => {
      if (col.todoIds?.includes(id)) {
        col.todoIds = col.todoIds.filter(tid => tid !== id);
      }
    });
  });
  
  save();
  return true;
}

/*** ====== HELPERS ====== ***/
const el=(q,r=document)=>r.querySelector(q), els=(q,r=document)=>Array.from(r.querySelectorAll(q));
function fmtDue(d){if(!d) return '‚Äî';const diff=(new Date(d)-new Date().setHours(0,0,0,0))/86400000;const days=Math.round(diff);
  if(days<0) return `‚ö† ${Math.abs(days)}d overdue`; if(days===0) return 'Today'; if(days===1) return 'Tomorrow'; return `in ${days}d`; }
const pColor=p=> '#'+(p.initials.charCodeAt(0)*99991 % 0xffffff).toString(16).padStart(6,'6f6f6f');
const score=t=> (t.eisen?.impact?4:0)+(t.eisen?.important?2:0)+(t.eisen?.urgent?1:0);
const projName= t=> store.projects[t.projectId]?.name || '';
const universalHaystack=t=>{
  const people=(t.people||[]).map(id=>store.people[id]?.name).filter(Boolean).join(' ');
  return [t.title,t.notes,(t.tags||[]).join(' '),t.status,score(t),t.id,t.due,projName(t),people].join(' ').toLowerCase();
};

/*** ====== NAV + IO ====== ***/
const tabs=el('#tabs');
const views=['todos','projects','people','kanban'];
function setTab(tab){views.forEach(id=>el('#view-'+id).classList.toggle('hidden',tab!==id)); store.current.tab=tab; save(); render();}

tabs.addEventListener('click',e=>{const b=e.target.closest('.tab'); if(!b) return; els('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); setTab(b.dataset.tab);});

el('#btnExport').onclick=()=>{const blob=new Blob([JSON.stringify(store,null,2)],{type:'application/json'});const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`jwdm-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove();};
el('#btnImport').onclick=()=>el('#fileImport').click();
el('#fileImport').addEventListener('change',e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const data=JSON.parse(r.result); if(!data.todos||!data.projects||!data.people) throw new Error('Invalid backup'); store=data; save(); render(true);}catch(err){alert('Import failed: '+err.message);}}; r.readAsText(f); e.target.value='';});

/*** ====== TODOS VIEW ====== ***/
const fSearch=el('#fSearch'), fProject=el('#fProject'), fPerson=el('#fPerson'), fSort=el('#fSort'), todoList=el('#todoList');
[fSearch,fProject,fPerson,fSort].forEach(c=>c.addEventListener('input',renderTodos));

const SORTS={
  'due-asc':(a,b)=> (a.due||'9999-12-31')<(b.due||'9999-12-31')?-1:1,
  'due-desc':(a,b)=> (a.due||'0000-01-01')>(b.due||'0000-01-01')?-1:1,
  'priority-desc':(a,b)=> score(b)-score(a),
  'priority-asc':(a,b)=> score(a)-score(b),
  'status-asc':(a,b)=> (a.status||'').localeCompare(b.status||''),
  'project-asc':(a,b)=> projName(a).localeCompare(projName(b)),
  'project-desc':(a,b)=> projName(b).localeCompare(projName(a)),
  'title-asc':(a,b)=> (a.title||'').localeCompare(b.title||''),
  'created-desc':(a,b)=> (b.created||0)-(a.created||0),
};

function ensureFilterOptions(){
  const curProj=fProject.value, curPerson=fPerson.value;
  const projOpts = `<option value="">All projects</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  const peopleOpts = `<option value="">All people</option>`+Object.values(store.people).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(fProject.innerHTML!==projOpts) fProject.innerHTML = projOpts; if(fPerson.innerHTML!==peopleOpts) fPerson.innerHTML = peopleOpts; fProject.value=curProj; fPerson.value=curPerson;
}

function renderTodos(){
  ensureFilterOptions();
  let items=Object.values(store.todos);
  const q=(fSearch.value||'').trim().toLowerCase(); if(q) items=items.filter(t=>universalHaystack(t).includes(q));
  const proj=fProject.value; if(proj) items=items.filter(t=>t.projectId===proj);
  const person=fPerson.value; if(person) items=items.filter(t=>(t.people||[]).includes(person));
  const sorter=SORTS[fSort.value]||SORTS['due-asc']; items.sort(sorter);
  el('#countInfo').textContent=`${items.length} shown ¬∑ ${Object.keys(store.todos).length} total`;

  const headerRow = `<div class="todoHeader">
    <div>Status</div>
    <div>Title</div>
    <div>Priority</div>
    <div>Project</div>
    <div>Due Date</div>
  </div>`;

  todoList.innerHTML=headerRow + items.map(t=>{
    const p=store.projects[t.projectId]; const ei=t.eisen||{impact:0,important:0,urgent:0};
    return `<div class="todoRow" data-id="${t.id}">
      <select class="statusSel badge status-${t.status||'todo'}" data-act="setStatus" data-id="${t.id}">
        ${['todo','in-progress','review','done'].map(sv=>`<option value="${sv}" ${t.status===sv?'selected':''}>${sv}</option>`).join('')}
      </select>
      <div class="title link" contenteditable="true" spellcheck="false" data-act="editTitle" data-id="${t.id}" title="Click to edit title">${t.title}</div>
      <div class="hiu" data-id="${t.id}">
        <span class="d h ${ei.impact?'on':''}" data-act="toggle" data-k="impact" title="High impact"></span>
        <span class="d i ${ei.important?'on':''}" data-act="toggle" data-k="important" title="Important"></span>
        <span class="d u ${ei.urgent?'on':''}" data-act="toggle" data-k="urgent" title="Urgent"></span>
      </div>
      <select class="projectSel" data-act="setProject" data-id="${t.id}" style="font-size:12px;border-radius:8px;padding:4px 8px;min-width:120px;background:var(--card);border:1px solid var(--border)">
        <option value="">(No project)</option>
        ${Object.values(store.projects).map(proj => `<option value="${proj.id}" ${t.projectId === proj.id ? 'selected' : ''}>${proj.name}</option>`).join('')}
      </select>
      <div class="link" style="padding:4px 8px;border-radius:8px;min-width:128px;background:var(--card);cursor:pointer" data-act="openModal" data-id="${t.id}" title="Click to edit todo">${t.due ? fmtDue(t.due) : '‚Äî'}</div>
      <div class="actions"></div>
    </div>`;
  }).join('');

  // interactions
  todoList.onchange=e=>{
    const id=e.target.dataset.id; if(!id) return;
    if(e.target.dataset.act==='setStatus'){store.todos[id].status=e.target.value; save(); renderTodos();}
    if(e.target.dataset.act==='setProject'){
      const oldProjectId = store.todos[id].projectId;
      const newProjectId = e.target.value;
      
      // Update todo's project
      store.todos[id].projectId = newProjectId;
      
      // Remove from old project
      if(oldProjectId && store.projects[oldProjectId]) {
        const oldProject = store.projects[oldProjectId];
        oldProject.todoIds = (oldProject.todoIds || []).filter(tid => tid !== id);
      }
      
      // Add to new project
      if(newProjectId && store.projects[newProjectId]) {
        const newProject = store.projects[newProjectId];
        if(!newProject.todoIds) newProject.todoIds = [];
        if(!newProject.todoIds.includes(id)) {
          newProject.todoIds.push(id);
        }
      }
      
      save(); 
      renderTodos();
      renderProjects(); // Update project view to reflect changes
      renderKanban(); // Update kanban view in case todos moved
    }
  };
  todoList.onclick=e=>{
    const id=e.target.dataset.id;
    if(e.target.dataset.act==='openModal'){ openTodoModal(id); }
    if(e.target.dataset.act==='toggle'){
      const k=e.target.dataset.k; const t=store.todos[e.target.closest('.hiu').dataset.id]; t.eisen=t.eisen||{impact:0,important:0,urgent:0}; t.eisen[k]=t.eisen[k]?0:1; save(); renderTodos();
    }
    
    // If clicking on a todo row but not on any specific control element, open the modal
    const todoRow = e.target.closest('.todoRow');
    if (todoRow && !e.target.dataset.act && !e.target.closest('select, input, button, .hiu .d')) {
      const todoId = todoRow.dataset.id;
      if (todoId) {
        openTodoModal(todoId);
      }
    }
  };
  // inline title edit
  todoList.addEventListener('keydown', (e)=>{ if(e.target.dataset.act==='editTitle' && e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});
  todoList.addEventListener('blur', (e)=>{ if(e.target.dataset.act==='editTitle'){ const id=e.target.dataset.id; const v=e.target.textContent.trim(); store.todos[id].title=v||store.todos[id].title; save(); } }, true);
}

/*** ====== PROJECTS VIEW ====== ***/
const projectList=el('#projectList');
el('#btnAddProject').onclick=()=>el('#dlgProject').showModal();
const saveProjectHandler = e=>{e.preventDefault(); const name=el('#pName').value.trim(); if(!name) return; const color=el('#pColor').value||'#7cc9ff'; const id='p'+nextId(); store.projects[id]={id,name,color,todoIds:[]}; save(); el('#dlgProject').close(); el('#projectForm').reset(); renderProjects(); renderTodos();};
el('#btnSaveProject').onclick=saveProjectHandler;
// Add Enter key handler for Project modal
el('#dlgProject').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    saveProjectHandler(e);
  }
});
function renderProjects(){
  projectList.innerHTML=Object.values(store.projects).map(p=>{
    const todos=(p.todoIds||[]).map(id=>store.todos[id]).filter(Boolean);
    const inline = todos.map((t,i)=>`<span class="item"><span class="link" data-act="open" data-id="${t.id}">${t.title}</span></span>${i<todos.length-1?'<span class="sep">¬∑</span>':''}`).join('');
    return `<div class="card" data-pid="${p.id}">
      <div class="cardhead">
        <div class="cardtitle"><span class="pill" style="background:${p.color};color:#000;border-color:transparent">‚óè</span> <span class="project-name" contenteditable="true" spellcheck="false" data-act="editProjectName" data-pid="${p.id}" title="Click to edit project name">${p.name}</span></div>
        <div style="display:flex;gap:6px">
          <button class="iconbtn action" data-pid="${p.id}" data-act="addToProject" title="Add todo here">Ôºã</button>
          <button class="iconbtn" data-pid="${p.id}" data-act="deleteProject" title="Delete project" style="background:var(--bad);color:#fff;border-color:transparent">üóë</button>
        </div>
      </div>
      <div class="inline-list">${inline || '<span class="note">No todos yet.</span>'}</div>
    </div>`;
  }).join('');
  projectList.onclick=e=>{ 
    if(e.target.dataset.act==='addToProject') openTodoModal(null,e.target.dataset.pid); 
    if(e.target.dataset.act==='open') openTodoModal(e.target.dataset.id); 
    if(e.target.dataset.act==='deleteProject') openDeleteProjectModal(e.target.dataset.pid);
    
    // If clicking on a project card but not on any specific control element, view the project
    const projectCard = e.target.closest('.card[data-pid]');
    if (projectCard && !e.target.dataset.act && !e.target.closest('button, .link[data-act="open"], .project-name')) {
      const projectId = projectCard.dataset.pid;
      if (projectId) {
        // Switch to todos view and filter by this project
        setTab('todos');
        fProject.value = projectId;
        renderTodos();
      }
    }
  };
  
  // Inline project name editing
  projectList.addEventListener('keydown', (e) => {
    if (e.target.dataset.act === 'editProjectName' && e.key === 'Enter') {
      e.preventDefault();
      e.target.blur();
    }
  });
  
  projectList.addEventListener('blur', (e) => {
    if (e.target.dataset.act === 'editProjectName') {
      const projectId = e.target.dataset.pid;
      const newName = e.target.textContent.trim();
      
      if (newName && store.projects[projectId]) {
        store.projects[projectId].name = newName;
        save();
        renderProjects();
        renderTodos(); // Update project dropdowns in todo rows
        renderKanban(); // Update kanban view project names
        refreshProjectSelects(); // Update project selects in modals
      } else if (!newName) {
        // Revert to original name if empty
        renderProjects();
      }
    }
  }, true);
}

/*** ====== PEOPLE VIEW ====== ***/
const peopleList=el('#peopleList');
el('#btnAddPerson').onclick=()=>el('#dlgPerson').showModal();
const savePersonHandler = e=>{e.preventDefault(); const name=el('#sName').value.trim(); if(!name) return; const initials=(el('#sInit').value.trim()||name.split(/\s+/).map(s=>s[0]).join('').slice(0,3)).toUpperCase(); const id=initials.toLowerCase()+nextId(); store.people[id]={id,name,initials,waitingForMe:[],waitingForThem:[]}; save(); el('#dlgPerson').close(); el('#personForm').reset(); renderPeople(); renderTodos();};
el('#btnSavePerson').onclick=savePersonHandler;
// Add Enter key handler for Person modal
el('#dlgPerson').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    savePersonHandler(e);
  }
});

function openDeleteProjectModal(projectId) {
  const project = store.projects[projectId];
  if (!project) return;
  
  const todoIds = project.todoIds || [];
  const todoCount = todoIds.length;
  
  el('#deleteProjectId').value = projectId;
  el('#deleteProjectName').textContent = project.name;
  el('#deleteTodoCount').textContent = todoCount === 0 ? 'no todos' : 
    todoCount === 1 ? '1 todo' : `${todoCount} todos`;
  
  // Populate reassign dropdown with other projects
  const reassignSelect = el('#reassignProjectSelect');
  const otherProjects = Object.values(store.projects).filter(p => p.id !== projectId);
  reassignSelect.innerHTML = '<option value="">Select target project...</option>' +
    otherProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  
  // Reset form to default (unassign)
  el('input[name="deleteMode"][value="unassign"]').checked = true;
  reassignSelect.disabled = true;
  
  // Hide reassign option if no other projects exist
  const reassignContainer = el('#reassignProjectContainer').closest('div');
  reassignContainer.style.display = otherProjects.length > 0 ? 'block' : 'none';
  
  el('#dlgDeleteProject').showModal();
}

function deleteProject(projectId, mode, targetProjectId = null) {
  const project = store.projects[projectId];
  if (!project) return false;
  
  const todoIds = project.todoIds || [];
  
  if (mode === 'deleteTodos') {
    // Delete all todos in this project
    todoIds.forEach(todoId => {
      deleteTodo(todoId);
    });
  } else if (mode === 'reassign' && targetProjectId) {
    // Reassign todos to another project
    const targetProject = store.projects[targetProjectId];
    if (!targetProject) return false;
    
    todoIds.forEach(todoId => {
      if (store.todos[todoId]) {
        store.todos[todoId].projectId = targetProjectId;
        // Add to target project's todo list
        if (!targetProject.todoIds.includes(todoId)) {
          targetProject.todoIds.push(todoId);
        }
      }
    });
  } else {
    // Unassign todos from project
    todoIds.forEach(todoId => {
      if (store.todos[todoId]) {
        store.todos[todoId].projectId = '';
      }
    });
  }
  
  // Delete the project itself
  delete store.projects[projectId];
  
  save();
  return true;
}

const deleteProjectHandler = e => {
  e.preventDefault();
  const projectId = el('#deleteProjectId').value;
  const mode = el('input[name="deleteMode"]:checked').value;
  const targetProjectId = el('#reassignProjectSelect').value;
  
  const project = store.projects[projectId];
  const todoCount = (project?.todoIds || []).length;
  
  // Validation for reassign mode
  if (mode === 'reassign' && !targetProjectId) {
    alert('Please select a target project to reassign todos to.');
    return;
  }
  
  let confirmMsg;
  if (mode === 'deleteTodos') {
    confirmMsg = `Are you sure you want to delete "${project.name}" and permanently delete all ${todoCount} todos?\n\nThis action cannot be undone!`;
  } else if (mode === 'reassign') {
    const targetProject = store.projects[targetProjectId];
    confirmMsg = `Delete "${project.name}" and move ${todoCount} todos to "${targetProject.name}"?`;
  } else {
    confirmMsg = `Delete "${project.name}"?\n\n${todoCount > 0 ? `${todoCount} todos will be unassigned but kept.` : 'No todos to unassign.'}`;
  }
  
  if (confirm(confirmMsg)) {
    if (deleteProject(projectId, mode, targetProjectId)) {
      el('#dlgDeleteProject').close();
      renderProjects();
      renderTodos();
      renderKanban();
      
      // Clear project filter if it was set to the deleted project
      if (fProject.value === projectId) {
        fProject.value = '';
        renderTodos();
      }
    }
  }
};

el('#btnConfirmDeleteProject').onclick = deleteProjectHandler;

// Handle radio button changes for delete mode
el('#dlgDeleteProject').addEventListener('change', e => {
  if (e.target.name === 'deleteMode') {
    const reassignSelect = el('#reassignProjectSelect');
    const isReassign = e.target.value === 'reassign';
    reassignSelect.disabled = !isReassign;
    if (!isReassign) {
      reassignSelect.value = '';
    }
  }
});

// Add Enter key handler for Delete Project modal  
el('#dlgDeleteProject').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    deleteProjectHandler(e);
  }
});
function recomputeTodoPeople(todoId){const ids=Object.values(store.people).filter(p=>(p.waitingForMe||[]).includes(todoId)||(p.waitingForThem||[]).includes(todoId)).map(p=>p.id); const t=store.todos[todoId]; if(t) t.people=[...new Set(ids)];}
function renderPeople(){
  peopleList.innerHTML=Object.values(store.people).map(p=>{
    const waitingForMe = p.waitingForMe || [];
    const waitingForThem = p.waitingForThem || [];
    const hasTasks = waitingForMe.length > 0 || waitingForThem.length > 0;
    
    if (!hasTasks) {
      // Compact view when no tasks
      return `<div class="card">
        <div class="cardhead">
          <div class="cardtitle" title="${p.id}"><span class="pill" style="background:${pColor(p)};color:#000;border-color:transparent">${p.initials}</span> ${p.name}</div>
          <div class="coltools">
            <button class="iconbtn action" data-pid="${p.id}" data-act="addWithPerson" title="New todo for ${p.name}">Ôºã</button>
            <button class="pill action" data-pid="${p.id}" data-side="waitingForMe" data-act="openAttach" style="font-size:11px;padding:2px 6px">Attach</button>
          </div>
        </div>
        <div style="padding:4px 0;color:var(--muted);font-size:12px">No tasks assigned</div>
      </div>`;
    }
    
    const listHtml=(arr,side)=> (arr||[]).map(tid=>{const t=store.todos[tid]; if(!t) return ''; return `<span class="pill" data-pid="${p.id}" data-side="${side}" data-tid="${tid}"><span class="link" data-act="open" data-id="${tid}">${t.title}</span>${t.due?` ¬∑ ${fmtDue(t.due)}`:''} <button class="xbtn" title="Remove">√ó</button></span>`;}).join('') || '<span class="note">‚Äî</span>';
    return `<div class="card">
      <div class="cardhead">
        <div class="cardtitle" title="${p.id}"><span class="pill" style="background:${pColor(p)};color:#000;border-color:transparent">${p.initials}</span> ${p.name}</div>
        <div class="coltools"><button class="iconbtn action" data-pid="${p.id}" data-act="addWithPerson" title="New todo for ${p.name}">Ôºã</button></div>
      </div>
      <div class="row">
        <div>
          <div class="tiny muted">I‚Äôm waiting on them</div>
          <div class="toolbar"><button class="pill action" data-pid="${p.id}" data-side="waitingForMe" data-act="openAttach">Attach tasks</button></div>
          <div class="chips">${listHtml(p.waitingForMe,'waitingForMe')}</div>
        </div>
        <div>
          <div class="tiny muted">They‚Äôre waiting on me</div>
          <div class="toolbar"><button class="pill action" data-pid="${p.id}" data-side="waitingForThem" data-act="openAttach">Attach tasks</button></div>
          <div class="chips">${listHtml(p.waitingForThem,'waitingForThem')}</div>
        </div>
      </div>
    </div>`;
  }).join('');

  peopleList.onclick=e=>{
    const act=e.target.dataset.act;
    if(act==='addWithPerson'){ openTodoModal(null,null,e.target.dataset.pid); return; }
    if(act==='openAttach'){ openAttachModal({type:'person', personId:e.target.dataset.pid, side:e.target.dataset.side}); return; }
    if(act==='open') openTodoModal(e.target.dataset.id);
    if(e.target.classList.contains('xbtn')){ const wrap=e.target.closest('.pill'); const pid=wrap.dataset.pid, side=wrap.dataset.side, tid=wrap.dataset.tid; const p=store.people[pid]; p[side]=p[side].filter(id=>id!==tid); recomputeTodoPeople(tid); save(); renderPeople(); renderTodos(); renderKanban(); }
  };
}

/*** ====== KANBAN ====== ***/
const kbSelect=el('#kbSelect'), kbProject=el('#kbProject'), kanbanGrid=el('#kanbanGrid');
el('#btnAddBoard').onclick=()=>{ const name=prompt('Board name?'); if(!name) return; const id='kb'+nextId(); store.kanbans[id]={id,name,columns:[{id:'col-'+nextId(),name:'Backlog',todoIds:[]}]}; store.current.activeKanbanId=id; save(); renderKanban(); };
kbSelect.onchange=()=>{store.current.activeKanbanId=kbSelect.value; save(); updateBoardControls(); renderKanban();};
kbProject.onchange=()=>renderKanban();

el('#btnEditBoard').onclick=()=>openBoardEditor();

function updateBoardControls() {
  const isDefaultBoard = store.current.activeKanbanId === 'default';
  el('#btnEditBoard').style.display = isDefaultBoard ? 'none' : '';
}

let pendingPlacement=null;

function renderKanban(){
  const boards=Object.values(store.kanbans);
  const allBoards = [{id:'default', name:'Default (By Status)'}].concat(boards);
  
  kbSelect.innerHTML=allBoards.map(k=>`<option value="${k.id}" ${store.current.activeKanbanId===k.id?'selected':''}>${k.name}</option>`).join('');
  if(!store.current.activeKanbanId){store.current.activeKanbanId='default'; save();}
  kbProject.innerHTML=`<option value="">All</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

  const filterProj=kbProject.value;
  const isDefaultBoard = store.current.activeKanbanId === 'default';
  
  if (isDefaultBoard) {
    // Special handling for the default board - show todos by status
    const statusColumns = [
      {id: 'todo', name: 'Todo', status: 'todo'},
      {id: 'in-progress', name: 'In Progress', status: 'in-progress'},
      {id: 'review', name: 'Review', status: 'review'},
      {id: 'done', name: 'Done', status: 'done'}
    ];
    
    kanbanGrid.innerHTML = statusColumns.map(col => {
      const todos = Object.values(store.todos).filter(t => t.status === col.status && (!filterProj || t.projectId === filterProj));
      const cards = todos.map(t => kanbanCard(t)).join('');
      return `<div class="column" data-col="${col.id}">
        <div class="colhead">
          <span>${col.name}</span>
          <div class="coltools">
            <span class="badge">${todos.length}</span>
          </div>
        </div>
        <div class="dropzone" data-col="${col.id}">${cards || '<div class="note">No todos here‚Ä¶</div>'}</div>
      </div>`;
    }).join('');
  } else {
    // Regular board handling
    const kb=store.kanbans[store.current.activeKanbanId];
    if (!kb) return;
    
    kanbanGrid.innerHTML=kb.columns.map(col=>{
      const cards=col.todoIds.map(id=>store.todos[id]).filter(Boolean).filter(t=>!filterProj||t.projectId===filterProj).map(t=>kanbanCard(t)).join('');
      return `<div class="column" data-col="${col.id}">
        <div class="colhead">
          <span contenteditable="true" spellcheck="false" data-act="renameCol" data-col="${col.id}" title="Click to rename">${col.name}</span>
          <div class="coltools">
            <button class="pill action" data-col="${col.id}" data-act="attachToCol" title="Attach existing">Ôºã</button>
            <button class="pill action" data-col="${col.id}" data-act="newToCol" title="New todo here">‚úö</button>
            <button class="pill" data-col="${col.id}" data-act="deleteCol" title="Delete column">üóë</button>
          </div>
        </div>
        <div class="dropzone" data-col="${col.id}">${cards||'<div class="note">Drop here‚Ä¶</div>'}</div>
      </div>`;
    }).join('');
  }

  els('.card[kb]').forEach(c=>{ c.draggable=true; c.addEventListener('dragstart',ev=>{ev.dataTransfer.setData('text/plain',c.dataset.id); c.classList.add('dragging'); ev.dataTransfer.effectAllowed='move';}); c.addEventListener('dragend',()=>c.classList.remove('dragging')); });
  els('.dropzone').forEach(z=>{ z.addEventListener('dragover',ev=>{ev.preventDefault(); z.classList.add('over');}); z.addEventListener('dragleave',()=>z.classList.remove('over')); z.addEventListener('drop',ev=>{ev.preventDefault(); z.classList.remove('over'); const todoId=ev.dataTransfer.getData('text/plain'); moveInKanban(todoId,z.dataset.col);}); });

  // inline column rename
  kanbanGrid.addEventListener('keydown', (e)=>{ if(e.target.dataset.act==='renameCol' && e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});
  kanbanGrid.addEventListener('blur', (e)=>{ if(e.target.dataset.act==='renameCol'){ const colId=e.target.dataset.col; const kb=store.kanbans[store.current.activeKanbanId]; const col=kb.columns.find(c=>c.id===colId); if(col){ col.name=e.target.textContent.trim()||col.name; save(); } } }, true);

  // delete column button
  kanbanGrid.addEventListener('click', (e)=>{ if(e.target.dataset.act==='deleteCol'){ const colId=e.target.dataset.col; const kb=store.kanbans[store.current.activeKanbanId]; if(kb.columns.length<=1) return alert('Need at least one column'); const i=kb.columns.findIndex(c=>c.id===colId); if(i>=0){ kb.columns.splice(i,1); save(); renderKanban(); } } });
  
  updateBoardControls();
}
function kanbanCard(t){ const p=store.projects[t.projectId]; return `<div class="card" kb data-id="${t.id}" data-act="openModal" style="cursor:pointer" title="Click to edit todo"><div class="cardhead"><div class="cardtitle tiny">${t.title}</div></div><div class="toolbar"><span class="pill"><span class="dot" style="color:${p?.color||'var(--muted)'}"></span>${p?.name||'‚Äî'}</span><span class="badge">${fmtDue(t.due)}</span><span class="badge">${t.status}</span></div></div>`; }
function moveInKanban(todoId,toColId){ 
  const isDefaultBoard = store.current.activeKanbanId === 'default';
  
  if (isDefaultBoard) {
    // For default board, update the todo's status
    const statusMap = {'todo': 'todo', 'in-progress': 'in-progress', 'review': 'review', 'done': 'done'};
    if (statusMap[toColId] && store.todos[todoId]) {
      store.todos[todoId].status = statusMap[toColId];
      save();
      renderKanban();
      renderTodos(); // Also update todos view since status changed
    }
  } else {
    // Regular board handling
    const kb=store.kanbans[store.current.activeKanbanId]; 
    kb.columns.forEach(c=>{const i=c.todoIds.indexOf(todoId); if(i>=0) c.todoIds.splice(i,1);}); 
    const tgt=kb.columns.find(c=>c.id===toColId); 
    if(tgt && !tgt.todoIds.includes(todoId)) tgt.todoIds.unshift(todoId); 
    save(); 
    renderKanban();
  }
}
kanbanGrid.addEventListener('click',e=>{ 
  if(e.target.dataset.act==='edit' || e.target.dataset.act==='openModal') {
    openTodoModal(e.target.dataset.id); 
  }
  
  // Check if clicked element is a kanban card or inside one
  const cardElement = e.target.closest('[kb]');
  if(cardElement && cardElement.dataset.id && !e.target.closest('button')) {
    openTodoModal(cardElement.dataset.id);
  }
  
  // Disable these actions for default board
  if (store.current.activeKanbanId !== 'default') {
    if(e.target.dataset.act==='attachToCol'){ openAttachModal({type:'kanban', boardId:store.current.activeKanbanId, colId:e.target.dataset.col}); } 
    if(e.target.dataset.act==='newToCol'){ pendingPlacement={boardId:store.current.activeKanbanId, colId:e.target.dataset.col}; openTodoModal(); }
  }
});

function openBoardEditor(){ 
  if (store.current.activeKanbanId === 'default') return; // Can't edit default board
  const kb=store.kanbans[store.current.activeKanbanId]; if(!kb) return; el('#bName').value=kb.name; const holder=el('#bCols'); holder.innerHTML = kb.columns.map(c=> `<div class="row" data-col="${c.id}"><div><input type="text" value="${c.name}" data-act="colName"></div><div><button class="pill" data-act="colUp">‚Üë</button> <button class="pill" data-act="colDown">‚Üì</button> <button class="pill" data-act="colDel">üóë</button></div></div>`).join(''); el('#dlgBoard').showModal();
}
el('#btnAddCol').onclick=()=>{ const kb=store.kanbans[store.current.activeKanbanId]; const id='col-'+nextId(); kb.columns.push({id,name:'New Column',todoIds:[]}); save(); openBoardEditor(); };
const saveBoardHandler = (e)=>{ e.preventDefault(); const kb=store.kanbans[store.current.activeKanbanId]; kb.name = el('#bName').value.trim()||kb.name; // names
  els('#bCols .row').forEach(r=>{ const id=r.dataset.col; const col=kb.columns.find(c=>c.id===id); if(col){ col.name = el('input[data-act="colName"]', r).value.trim()||col.name; }}); save(); el('#dlgBoard').close(); renderKanban(); };
el('#btnSaveBoard').onclick=saveBoardHandler;
// Add Enter key handler for Board modal
el('#dlgBoard').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    saveBoardHandler(e);
  }
});
el('#bCols')?.addEventListener('click',(e)=>{ const kb=store.kanbans[store.current.activeKanbanId]; const row=e.target.closest('.row'); if(!row) return; const id=row.dataset.col; const i=kb.columns.findIndex(c=>c.id===id); if(e.target.dataset.act==='colUp' && i>0){ const [c]=kb.columns.splice(i,1); kb.columns.splice(i-1,0,c); openBoardEditor(); }
  if(e.target.dataset.act==='colDown' && i<kb.columns.length-1){ const [c]=kb.columns.splice(i,1); kb.columns.splice(i+1,0,c); openBoardEditor(); }
  if(e.target.dataset.act==='colDel'){ if(kb.columns.length<=1) return alert('Need at least one column'); kb.columns.splice(i,1); openBoardEditor(); }
});

/*** ====== TODO MODAL ====== ***/
const dlgTodo=el('#dlgTodo');
const tId=el('#tId'), tTitle=el('#tTitle'), tNotes=el('#tNotes'), tProject=el('#tProject'), tDue=el('#tDue'), tStatus=el('#tStatus'), selWaitingOn=el('#selWaitingOn'), selWaitingOnMe=el('#selWaitingOnMe'), eisenForm=el('#eisenForm');
el('#fabAdd').onclick=()=>openTodoModal();
function setEisenUI(e){ els('.d', eisenForm).forEach(b=>{ const k=b.dataset.k; b.classList.toggle('on', !!e[k]); }); }
eisenForm.addEventListener('click', (ev)=>{ const btn=ev.target.closest('.d'); if(!btn) return; btn.classList.toggle('on'); });
function openTodoModal(id=null,presetProjectId=null,presetPersonId=null){ 
  refreshProjectSelects(); refreshPeopleSelects(); 
  if(id){ 
    const t=store.todos[id]; 
    tId.value=t.id; tTitle.value=t.title||''; tNotes.value=t.notes||''; tProject.value=t.projectId||''; tDue.value=t.due||''; tStatus.value=t.status||'todo'; 
    const waitingOnIds=Object.values(store.people).filter(p=>p.waitingForMe?.includes(id)).map(p=>p.id); 
    const waitingOnMeIds=Object.values(store.people).filter(p=>p.waitingForThem?.includes(id)).map(p=>p.id); 
    setMultiSel(selWaitingOn,new Set(waitingOnIds)); setMultiSel(selWaitingOnMe,new Set(waitingOnMeIds)); 
    setEisenUI(t.eisen||{impact:0,important:0,urgent:0}); 
    el('#todoFormTitle').textContent='Edit Todo'; 
    el('#btnDeleteTodo').style.display='block';
  }else{ 
    tId.value=''; el('#todoForm').reset(); tProject.value=presetProjectId||''; 
    setMultiSel(selWaitingOn,new Set(presetPersonId?[presetPersonId]:[])); setMultiSel(selWaitingOnMe,new Set()); 
    setEisenUI({impact:0,important:0,urgent:0}); 
    el('#todoFormTitle').textContent='New Todo'; 
    el('#btnDeleteTodo').style.display='none';
  } 
  dlgTodo.showModal(); 
}
function refreshProjectSelects(){ const opts=`<option value="">(none)</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); tProject.innerHTML=opts; el('#aProject').innerHTML=`<option value="">All projects</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); el('#kbProject').innerHTML=`<option value="">All</option>`+Object.values(store.projects).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
function refreshPeopleSelects(){ const options=Object.values(store.people).map(p=>`<option value="${p.id}">${p.name} (${p.initials})</option>`).join(''); selWaitingOn.innerHTML=options; selWaitingOnMe.innerHTML=options; fPerson.innerHTML=`<option value="">All people</option>`+Object.values(store.people).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); el('#aPerson').innerHTML=`<option value="">All people</option>`+Object.values(store.people).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
function setMultiSel(selectEl,set){Array.from(selectEl.options).forEach(o=>o.selected=set.has(o.value));}
function getMultiSel(selectEl){return Array.from(selectEl.selectedOptions).map(o=>o.value);} 
const saveTodoHandler = e=>{ e.preventDefault(); const isEdit=!!tId.value; const id=isEdit?tId.value:nextId(); const projectId=tProject.value||''; const waitingOn=new Set(getMultiSel(selWaitingOn)); const waitingOnMe=new Set(getMultiSel(selWaitingOnMe)); const ev=[...els('.d',eisenForm)].reduce((a,b)=>{a[b.dataset.k]=b.classList.contains('on')?1:0;return a;},{impact:0,important:0,urgent:0}); const todo={id,title:tTitle.value.trim(),notes:tNotes.value.trim(),projectId, people:[...new Set([...waitingOn,...waitingOnMe])], tags:(el('#tTags')?.value||'').split(',').map(s=>s.trim()).filter(Boolean), eisen:ev, due:tDue.value||'',status:tStatus.value,created:isEdit?store.todos[id].created:Date.now() }; store.todos[id]=todo; Object.values(store.projects).forEach(p=>{const has=p.todoIds?.includes(id); if(p.id===projectId && !has){(p.todoIds||(p.todoIds=[])).push(id);} if(p.id!==projectId && has){p.todoIds.splice(p.todoIds.indexOf(id),1);} }); Object.values(store.people).forEach(p=>{ p.waitingForMe=(p.waitingForMe||[]).filter(tid=>tid!==id); p.waitingForThem=(p.waitingForThem||[]).filter(tid=>tid!==id); if(waitingOn.has(p.id)) (p.waitingForMe||=[]).push(id); if(waitingOnMe.has(p.id)) (p.waitingForThem||=[]).push(id); }); if(pendingPlacement && !isEdit){ moveInKanban(id, pendingPlacement.colId); pendingPlacement=null; } save(); dlgTodo.close(); render(true); };
el('#btnSaveTodo').onclick=saveTodoHandler;

// Clear multi-select handlers
el('#btnClearWaitingOn').onclick = () => {
  Array.from(el('#selWaitingOn').options).forEach(option => option.selected = false);
};

el('#btnClearWaitingOnMe').onclick = () => {
  Array.from(el('#selWaitingOnMe').options).forEach(option => option.selected = false);
};

// Delete todo handler
el('#btnDeleteTodo').onclick = e => {
  e.preventDefault();
  const id = tId.value;
  if (!id) return;
  
  const todo = store.todos[id];
  const confirmMsg = `Are you sure you want to delete "${todo?.title || 'this todo'}"?\n\nThis action cannot be undone.`;
  
  if (confirm(confirmMsg)) {
    deleteTodo(id);
    dlgTodo.close();
    render(true);
  }
};

// Add Enter key handler for Todo modal
dlgTodo.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    saveTodoHandler(e);
  }
});

/*** ====== ATTACH MODAL ====== ***/
const dlgAttach=el('#dlgAttach');
const aSearch=el('#aSearch'), aProject=el('#aProject'), aPerson=el('#aPerson'), aStatus=el('#aStatus'), aSort=el('#aSort'), attachList=el('#attachList');
[aSearch,aProject,aPerson,aStatus,aSort].forEach(c=>c.addEventListener('input',renderAttachList));
let attachCtx=null;
function openAttachModal(ctx){ attachCtx=ctx; const title=ctx.type==='person' ? `Attach tasks ‚Üí ${store.people[ctx.personId]?.name} ¬∑ ${ctx.side==='waitingForMe'?'I‚Äôm waiting on them':'They‚Äôre waiting on me'}` : `Attach tasks ‚Üí Board ‚Äú${store.kanbans[ctx.boardId]?.name}‚Äù, Column ‚Äú${store.kanbans[ctx.boardId]?.columns.find(c=>c.id===ctx.colId)?.name}‚Äù`; el('#attachTitle').textContent=title; refreshProjectSelects(); refreshPeopleSelects(); aSearch.value=''; aProject.value=''; aPerson.value=''; aStatus.value=''; aSort.value='due-asc'; renderAttachList(); dlgAttach.showModal(); }
function renderAttachList(){ let items=Object.values(store.todos); const q=aSearch.value.trim().toLowerCase(); if(q){ items=items.filter(t=>universalHaystack(t).includes(q)); } const proj=aProject.value; if(proj) items=items.filter(t=>t.projectId===proj); const person=aPerson.value; if(person) items=items.filter(t=>(t.people||[]).includes(person)); const st=aStatus.value; if(st) items=items.filter(t=>t.status===st); if(attachCtx?.type==='person'){ const p=store.people[attachCtx.personId]; const arr=(p?.[attachCtx.side]||[]); items=items.filter(t=>!arr.includes(t.id)); } else if(attachCtx?.type==='kanban'){ const kb=store.kanbans[attachCtx.boardId]; const set=new Set(kb?.columns.flatMap(c=>c.todoIds)||[]); items=items.filter(t=>!set.has(t.id)); }
  const sorter=SORTS[aSort.value]||SORTS['due-asc']; items.sort(sorter);
  el('#aCount').textContent=`${items.length} candidates`;
  attachList.innerHTML=items.map(t=>{ const p=store.projects[t.projectId]; return `<div class="todoRow" data-id="${t.id}">
      <input type="checkbox" data-id="${t.id}" />
      <div class="title">${t.title}</div>
      <div class="hiu">
        <span class="d h ${t.eisen?.impact?'on':''}"></span>
        <span class="d i ${t.eisen?.important?'on':''}"></span>
        <span class="d u ${t.eisen?.urgent?'on':''}"></span>
      </div>
      <div class="pill"><span class="dot" style="color:${p?.color||'var(--muted)'}"></span>${p?.name||'‚Äî'}</div>
      <div class="badge">${fmtDue(t.due)}</div>
      <div class="actions"></div>
    </div>`; }).join(''); }
const attachConfirmHandler = e=>{ e.preventDefault(); const ids=els('input[type="checkbox"]:checked',attachList).map(c=>c.dataset.id); if(!ids.length){dlgAttach.close(); return;} if(attachCtx.type==='person'){ const p=store.people[attachCtx.personId]; const arr=(p[attachCtx.side] ||= []); ids.forEach(id=>{ if(!arr.includes(id)) arr.push(id); recomputeTodoPeople(id); }); save(); dlgAttach.close(); renderPeople(); renderTodos(); } else if(attachCtx.type==='kanban'){ ids.forEach(id=>moveInKanban(id, attachCtx.colId)); dlgAttach.close(); } };
el('#btnAttachConfirm').onclick=attachConfirmHandler;
// Add Enter key handler for Attach modal
el('#dlgAttach').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    attachConfirmHandler(e);
  }
});

/*** ====== COMMAND PALETTE ====== ***/
const kbar=el('#kbar'), kinput=el('#kinput'), klist=el('#klist');
const CMDS=[
  {label:'New todo', run:()=>openTodoModal()},
  {label:'Go: Todos', run:()=>setTab('todos')},
  {label:'Go: Projects', run:()=>setTab('projects')},
  {label:'Go: People', run:()=>setTab('people')},
  {label:'Go: Kanban', run:()=>setTab('kanban')},
  {label:'New project', run:()=>el('#dlgProject').showModal()},
  {label:'New person', run:()=>el('#dlgPerson').showModal()},
  {label:'New board', run:()=>el('#btnAddBoard').click()},
  {label:'Edit current board', run:()=>openBoardEditor()},
  {label:'Filter status: todo', run:()=>{ setTab('todos'); fSort.value='due-asc'; fPerson.value=''; fProject.value=''; fSearch.value=''; renderTodos(); }},
  {label:'Focus search', run:()=>{ setTab('todos'); fSearch.focus(); }},
];
let ksel=0; function openK(){ kbar.classList.add('open'); kbar.setAttribute('aria-hidden','false'); kinput.value=''; renderK(''); kinput.focus(); }
function closeK(){ kbar.classList.remove('open'); kbar.setAttribute('aria-hidden','true'); }
function renderK(q){ const items=CMDS.filter(c=>c.label.toLowerCase().includes(q.toLowerCase())); ksel=0; klist.innerHTML=items.map((c,i)=>`<div class="kitem ${i===0?'sel':''}" data-i="${i}">${c.label}<span class="tiny muted">‚Ü©</span></div>`).join(''); }
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); if(kbar.classList.contains('open')) closeK(); else openK(); }});
kbar.addEventListener('click',(e)=>{ if(e.target===kbar) closeK(); });
kinput.addEventListener('input',()=>renderK(kinput.value));
kinput.addEventListener('keydown',(e)=>{ const items=Array.from(klist.children); if(e.key==='ArrowDown'){ e.preventDefault(); ksel=Math.min(ksel+1, items.length-1); items.forEach((n,i)=>n.classList.toggle('sel',i===ksel)); }
  if(e.key==='ArrowUp'){ e.preventDefault(); ksel=Math.max(0, ksel-1); items.forEach((n,i)=>n.classList.toggle('sel',i===ksel)); }
  if(e.key==='Enter'){ e.preventDefault(); const q=kinput.value.toLowerCase(); const matches=CMDS.filter(c=>c.label.toLowerCase().includes(q)); if(matches[ksel]){ closeK(); matches[ksel].run(); }}
  if(e.key==='Escape'){ closeK(); }
});

/*** ====== INIT & RENDER ====== ***/
function render(){ els('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===store.current.tab)); views.forEach(id=>el('#view-'+id).classList.toggle('hidden',store.current.tab!==id)); renderTodos(); renderProjects(); renderPeople(); renderKanban(); }

render();
</script>

</body>
</html>
